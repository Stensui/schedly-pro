<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Schedly Pro | Full System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" type="image/png" href="schedly-logo.png">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    
    
    <style>
    :root { 
        --accent: #D4AF37; 
        --bg: #050505; 
        --card: #111111; 
        --text: #ffffff; 
        --error: #ff5f57; 
        --success: #4cd964; 
        --maint: #ff9f0a; 
        --sidebar: #080808; 
    }
    
    * { 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent; 
        font-family: 'Inter', sans-serif; 
    }

    body { 
        margin: 0; 
        background: var(--bg); 
        color: var(--text); 
        height: 100vh; 
        overflow: hidden; 
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }

    .status-indicator { position: fixed; top: 20px; right: 20px; z-index: 5000; }
    
    .badge { 
        padding: 8px 14px; 
        border-radius: 30px; 
        font-size: 10px; 
        font-weight: 800; 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        background: rgba(0,0,0,0.6); 
        border: 1px solid rgba(255,255,255,0.1); 
        backdrop-filter: blur(10px); 
    }

    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .badge.online { color: var(--success); border-color: var(--success); }
    .badge.online .dot { background: var(--success); box-shadow: 0 0 10px var(--success); }

    @keyframes viewFade {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .view { 
        display: none; 
        position: absolute; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        overflow-y: auto; padding: 20px; 
        z-index: 10;
        -webkit-overflow-scrolling: touch; 
        scroll-behavior: smooth; 
    }

    .view.active { 
        display: flex; 
        flex-direction: column; 
        animation: viewFade 0.3s ease-in; 
    }

    .auth-box { 
        background: var(--card); 
        padding: 40px 30px; 
        border-radius: 32px; 
        border: 1px solid rgba(212,175,55,0.15); 
        width: 100%; 
        max-width: 420px; 
        text-align: center; 
        margin: auto; 
        position: relative; 
    }

    .strength-bar { height: 100%; width: 0%; transition: 0.3s; border-radius: 2px; }
    .weak { background-color: #ff5f57 !important; } 
    .mid { background-color: #ff9f0a !important; } 
    .strong { background-color: #4cd964 !important; }

    input, select, textarea { 
        width: 100%; 
        padding: 16px; 
        margin-bottom: 15px; 
        border-radius: 16px; 
        border: 1px solid #222; 
        background: #000; 
        color: #fff; 
        outline: none; 
    }

    .btn {
    width: 100%;
    padding: 12px;
    background: #111; 
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    border: 2px solid var(--accent); 
    border-radius: 50px; 
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: none; 
    letter-spacing: 0.5px;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.1); 
}

.btn:hover {
    background: var(--accent);
    color: #000;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
}

.btn:active {
    transform: scale(0.95); 
}

    .admin-layout { display: flex; height: 100vh; width: 100vw; }
    
    .sidebar { 
        width: 80px; 
        background: var(--sidebar); 
        border-right: 1px solid #151515; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 40px 0; 
        gap: 30px; 
        z-index: 100; 
    }

    .nav-item { 
        color: #333; 
        font-size: 24px; 
        cursor: pointer; 
        padding: 12px; 
        border-radius: 16px; 
    }

    .nav-item.active { 
        color: var(--accent); 
        background: rgba(212,175,55,0.08); 
    }

    .main-panel { flex: 1; padding: 40px; overflow-y: auto; background: #000; }
    .admin-card { display: none; } 
    .admin-card.active { display: block; }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    
    .stat-item { 
        background: var(--card); 
        padding: 20px; 
        border-radius: 24px; 
        border: 1px solid #222; 
        text-align: center; 
    }

    .list-container { background: #080808; border-radius: 20px; border: 1px solid #111; margin-bottom: 25px; }
    
    .item-row { 
        padding: 18px 25px; 
        border-bottom: 1px solid #111; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }

    #maint-screen { 
        display: none; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100vw; height: 100vh; 
        background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%); 
        z-index: 10000; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        text-align: center; 
    }

    .maint-timer { font-family: monospace; font-size: 42px; font-weight: 800; color: var(--accent); }

    .badge.maintenance { color: var(--maint); border-color: var(--maint); }
    .badge.maintenance .dot { background: var(--maint); box-shadow: 0 0 10px var(--maint); }
    .badge.terminated { color: var(--error); border-color: var(--error); }
    .badge.terminated .dot { background: var(--error); box-shadow: 0 0 10px var(--error); }

    .gender-option { flex: 1; cursor: pointer; }
    .gender-option input { display: none; }
    .gender-card { 
        background: #1a1a1a; border: 1px solid #333; padding: 12px; border-radius: 12px; 
        text-align: center; font-size: 14px; font-weight: 600; transition: 0.3s; color: #888; 
    }

    .gender-option input[value="Male"]:checked + .gender-card { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); color: #2196F3; transform: scale(1.05); }
    .gender-option input[value="Female"]:checked + .gender-card { border-color: #E91E63; background: rgba(233, 30, 99, 0.1); color: #E91E63; transform: scale(1.05); }

    .terms-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; width: 100%; }
    .terms-wrapper input[type="checkbox"] { width: 18px !important; height: 18px !important; margin: 0 !important; cursor: pointer; }
    .terms-wrapper label { font-size: 12px; color: #aaa; cursor: pointer; white-space: nowrap; }

    #term-screen { position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 99999; display: none; flex-direction: column; justify-content: center; align-items: center; }

    .id-card { 
        background: linear-gradient(135deg, #1e1e1e 0%, #111 100%); 
        border: 1px solid #333; 
        border-radius: 20px; 
        padding: 20px; 
        position: relative; 
        overflow: hidden; 
        margin-bottom: 20px; 
    } 
    .subject-grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    .subject-card { 
        background: #111; border: 1px solid #222; padding: 20px; border-radius: 20px; 
        text-align: left; cursor: pointer; transition: 0.2s; 
    }
    .subject-card:active { transform: scale(0.98); border-color: var(--accent); }
    .subject-card b { display: block; color: white; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .subject-card small { color: #666; font-size: 10px; display: block; }
    .main-logo { width: 80px; height: auto; margin-bottom: 15px; filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.5)); }
    .brand-font { font-family: 'Inter', sans-serif; color: var(--accent); letter-spacing: 2px; font-weight: 800; margin-bottom: 5px; }
    #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease; }
    .splash-content { text-align: center; }
    .splash-logo { width: 120px; animation: pulse 1.5s infinite ease-in-out; }
    .splash-text { font-size: 24px; letter-spacing: 4px; margin-top: 15px; font-weight: 800; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
    .loader-bar { width: 150px; height: 3px; background: #222; margin: 20px auto; border-radius: 10px; overflow: hidden; }
    .progress { width: 0%; height: 100%; background: var(--accent); animation: load 5s forwards; }
    @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
    .modal { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); z-index: 9999; display: none; 
        justify-content: center; align-items: center; backdrop-filter: blur(8px); padding: 20px; 
    }

    .modal-content { 
        background: #0a0a0a; padding: 30px; border-radius: 28px; border: 1px solid #222; 
        width: 100%; max-width: 400px; 
    }

    .task-item { background: #151515; padding: 14px; border-radius: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #1a1a1a; font-size: 13px; color: #eee; }

    .add-btn-small { background: var(--accent); color: black; border: none; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 10px; cursor: pointer; }

    .id-top { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .profile-circle { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: black; }

    .id-info h2 { margin: 0; font-size: 18px; color: white; }
    .id-info p { margin: 0; font-size: 12px; color: var(--accent); }
    .id-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; border-top: 1px solid #222; padding-top: 15px; }
    .detail-item small { display: block; color: #555; font-size: 9px; margin-bottom: 2px; }
    .detail-item p { margin: 0; font-size: 12px; color: #ccc; }
    .id-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }

    .badge { background: rgba(76, 217, 100, 0.1); color: #4cd964; padding: 5px 10px; border-radius: 5px; font-size: 10px; font-weight: bold; }
    #st-mini-qr { width: 50px; height: 50px; border-radius: 5px; background: white; padding: 2px; }

    .main-grid { display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); padding: 10px 0; }

    @media (min-width: 768px) {
        .main-grid { grid-template-columns: repeat(4, 1fr); max-width: 1000px; margin: 0 auto; }
        .full-span { grid-column: span 4 !important; }
    }

    .nav-card { 
    background: #111; 
    border: 1px solid #222; 
    padding: 20px; 
    border-radius: 24px; 
    cursor: pointer; 
    display: flex; 
    flex-direction: column; 
    align-items: flex-start; 
    position: relative; 
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}
    .nav-card:hover {
    transform: translateY(-8px); 
    border-color: var(--accent); 
    background: linear-gradient(145deg, #161616, #111); 
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(212, 175, 55, 0.15); 
}
    .nav-card:hover .card-icon {
    transform: scale(1.2) rotate(-5deg);
    filter: drop-shadow(0 0 8px var(--accent));
}
    .nav-card:active { transform: scale(0.96); background: #1a1a1a; border-color: var(--accent); }
    .nav-card b { font-size: 13px; margin-top: 10px; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-card small { font-size: 10px; color: #666; margin-top: 2px; }
    .card-icon { font-size: 24px; }
    #map-container { width: 100%; height: 200px; border-radius: 20px; margin-top: 15px; border: 1px solid #333; }
    .team-card { background: #0d0d0d; border: 1px solid #1a1a1a; padding: 15px; border-radius: 20px; text-align: center; }
     .card-icon {
    font-size: 24px;
    transition: transform 0.3s ease;
}


.subject-card { 
    background: #111; 
    border: 1px solid #222; 
    padding: 20px; 
    border-radius: 20px; 
    text-align: left; 
    cursor: pointer; 
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

.subject-card:hover { 
    border-color: var(--accent); 
    background: #1a1a1a;
    transform: scale(1.03); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

    @keyframes viewEntrance {
    from { 
        opacity: 0; 
        transform: scale(0.95) translateY(10px); 
    }
    to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    }
}

    .view.active { 
    display: flex; 
    flex-direction: column; 
    animation: viewEntrance 0.5s ease-out forwards; 
}
* {
    box-sizing: border-box !important;
}

html, body {
    max-width: 100vw !important;
    overflow-x: hidden !important; 
    padding: 0;
}

.view, .admin-card, .modal-content {
    width: 100% !important; 
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 15px !important; 
    padding-right: 15px !important;
}

img, canvas {
    max-width: 100%;
    height: auto;
}
.view {
    width: 100vw !important;
    max-width: 100vw !important;
    overflow-x: hidden !important; 
    box-sizing: border-box !important;
}

* {
    box-sizing: border-box !important;
}
#timer-display {
    font-size: 18vw !important; 
    line-height: 1;
    width: 100% !important;
    text-align: center;
    font-family: 'Courier New', monospace; 
    align-items: center;
    letter-spacing: -2px; 
}

#timer-input-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
}

#custom-min {
    width: 100% !important;
    max-width: 250px;
}


#peer-feed div {
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    word-break: break-word !important; 
    max-width: 100% !important;
}

#peer-feed p {
    word-wrap: break-word !important;
    white-space: pre-wrap !important; 
}
#notif-list-container {
    overflow-y: auto; 
    max-height: 70vh; 
    padding-bottom: 20px;
}
.falling-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: -1; 
    pointer-events: none;
}

.falling-item {
    position: absolute;
    top: -50px;
    font-size: 24px;
    opacity: 0.6;
    user-select: none;
    animation: fall linear forwards;
}

@keyframes fall {
    0% {
        transform: translateY(0) rotate(0deg);
        opacity: 0;
    }
    10% { opacity: 0.6; }
    90% { opacity: 0.6; }
    100% {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
    }
}
.logo-float {
    animation: floating 3s ease-in-out infinite;
}

@keyframes floating {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
#log-u, #log-p {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: white !important;
    border-radius: 8px !important;
    padding: 12px !important;
    transition: all 0.3s ease;
}

#log-u:focus, #log-p:focus {
    border-color: var(--accent) !important;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.3) !important;
    background: rgba(255, 255, 255, 0.08) !important;
    outline: none;
}
.mobile-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #fff !important;
    padding: 10px 15px !important;
    border-radius: 8px !important;
    font-size: 14px !important; 
    outline: none;
    transition: 0.3s;
    box-sizing: border-box; 
}

.mobile-input:focus {
    border-color: var(--accent) !important;
    background: rgba(255, 255, 255, 0.08) !important;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
}
.auth-box {
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid rgba(212, 175, 55, 0.2);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    box-sizing: border-box;
}
.spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 0.8s linear infinite;
    display: inline-block;
    vertical-align: middle;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.btn-loading {
    pointer-events: none; 
    opacity: 0.8;
}
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    display: none; 
    justify-content: center;
    align-items: center;
    z-index: 10000; 
    padding: 20px;
    box-sizing: border-box;
}
#timer-display {
    text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    animation: timerPulse 2s infinite alternate;
}

@keyframes timerPulse {
    from { opacity: 0.8; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
    to { opacity: 1; text-shadow: 0 0 25px rgba(212, 175, 55, 0.6); }
}
   * {
    touch-action: manipulation; 
    -webkit-text-size-adjust: none; 
}

input, button, textarea {
    font-size: 16px !important;
}
@keyframes modalPop {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes textSlide {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
}

#welcome-modal {
    animation: fadeIn 0.3s ease-out;
}
#modal-content {
    animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.modal-text-animate {
    animation: textSlide 0.3s ease-out;
}
@keyframes modalPop {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}
@keyframes fadeIn {
    from { background: rgba(0,0,0,0); }
    to { background: rgba(0,0,0,0.9); }
}
#logout-modal {
    animation: fadeIn 0.3s ease-out;
}
#logout-modal .modal-content {
    animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#logout-modal button:active {
    transform: scale(0.95);
    filter: brightness(0.8);
}
@keyframes musicPulse {
    0% { 
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        transform: scale(1);
    }
    50% { 
        box-shadow: 0 0 20px rgba(212,175,55, 0.6);
        transform: scale(1.08);
    }
    100% { 
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        transform: scale(1);
    }
}
.music-playing {
    animation: musicPulse 2s infinite ease-in-out !important;
    border-color: #fff !important;
}
#bio-modal, #support-modal, #logout-modal {
    display: none; 
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 999999;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
}
.modal-content-fix {
    width: 100%;
    max-width: 340px; 
    margin: auto; 
    position: relative;
}
#task-delete-modal .modal-content {
    animation: apkModalPop 0.2s ease-out;
}

@keyframes apkModalPop {
    from { transform: scale(0.85); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

#task-delete-modal button {
    outline: none;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.1s ease;
}

#task-delete-modal button:active {
    transform: scale(0.94); 
    filter: brightness(0.8);
}
@keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes modalPopUp {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.modal-content {
    animation: modalPopUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: rgba(26, 26, 26, 0.95) !important;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}
button:active {
    transform: scale(0.92);
    transition: 0.1s;
}
#confirm-task-done-btn {
    box-shadow: 0 0 15px rgba(76, 217, 100, 0.3);
    transition: 0.3s;
}
#confirm-task-done-btn:hover {
    box-shadow: 0 0 25px rgba(76, 217, 100, 0.5);
}
.custom-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #111;
    border: 1px solid var(--accent);
    padding: 20px;
    border-radius: 15px;
    z-index: 10000;
    text-align: center;
    width: 80%;
    max-width: 300px;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
}

.toast-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 9999;
}
@keyframes goldShine {
    0% { filter: drop-shadow(0 0 2px #FFD700); transform: scale(1); opacity: 0.8; }
    50% { filter: drop-shadow(0 0 10px #FFFACD); transform: scale(1.1); opacity: 1; }
    100% { filter: drop-shadow(0 0 2px #FFD700); transform: scale(1); opacity: 0.8; }
}
@keyframes eliteGoldFrame {
    0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); border-color: #443300; }
    50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); border-color: #B8860B; }
    100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); border-color: #443300; }
}
.admin-luxury-card {
    background: #0a0a0a !important;
    border: 1px solid #B8860B !important;
    animation: eliteGoldFrame 4s infinite ease-in-out;
}
@keyframes goldShine {
    0% { filter: drop-shadow(0 0 2px #FFD700); }
    50% { filter: drop-shadow(0 0 8px #FFD700); transform: scale(1.05); }
    100% { filter: drop-shadow(0 0 2px #FFD700); }
}
.admin-luxury-card {
    background: #0a0a0a !important;
    border: 1px solid #B8860B !important;
    box-shadow: 0 0 15px rgba(184, 134, 11, 0.1);
}
.dev-send-btn {
    background: linear-gradient(45deg, #B8860B, #FFD700) !important;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    animation: goldShine 2s infinite ease-in-out;
}
@keyframes adminFly {
    0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
    100% { transform: translateY(-100vh) scale(2) rotate(360deg); opacity: 0; }
}
.admin-heart {
    position: fixed; 
    bottom: -50px;
    font-size: 30px; 
    pointer-events: none;
    z-index: 99999; 
    user-select: none;
    animation: adminFly 1.5s ease-out forwards;
}
@keyframes screenShake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}
.shake-effect {
    animation: screenShake 0.4s; 
    animation-iteration-count: 1;
}
@keyframes thanosSnap {
    0% { transform: scale(1); filter: blur(0); opacity: 1; }
    50% { transform: scale(1.05) rotate(1deg); filter: blur(2px); opacity: 0.7; }
    100% { transform: scale(0.8) translateY(-20px) rotate(-2deg); filter: blur(10px); opacity: 0; }
}
.banished-post {
    animation: thanosSnap 1.2s ease-in forwards !important;
    pointer-events: none; 
}
@keyframes adminGlow {
    0% { text-shadow: 0 0 5px rgba(255, 215, 0, 0.4); opacity: 0.8; }
    50% { text-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.4); opacity: 1; }
    100% { text-shadow: 0 0 5px rgba(255, 215, 0, 0.4); opacity: 0.8; }
}

@keyframes starSparkle {
    0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
    50% { transform: scale(1.3) rotate(15deg); filter: brightness(1.5); }
    100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
}

.admin-sparkle {
    display: inline-block;
    animation: starSparkle 1.5s infinite ease-in-out;
    color: #FFD700;
    margin-left: 5px;
}

.admin-glow-text {
    animation: adminGlow 2s infinite ease-in-out;
}
@keyframes borderGlow {
    0% { border: 3px solid #FFD700; box-shadow: 0 0 5px #FFD700; }
    50% { border: 3px solid #ffffff; box-shadow: 0 0 20px #FFD700, inset 0 0 10px #FFD700; }
    100% { border: 3px solid #FFD700; box-shadow: 0 0 5px #FFD700; }
}
.admin-border-active {
    background: none !important; 
    border: 3px solid #FFD700 !important;
    animation: borderGlow 2s infinite ease-in-out !important;
    box-sizing: border-box !important;
}
@keyframes marquee-infinite {
    0% { left: 100%; }
    100% { left: -200%; }
}

body.effect-nika {
    background-color: white !important;
    animation: nika-bounce 1.0s ease-in-out infinite !important;
    will-change: transform;
}

@keyframes nika-bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); } 
}
#broadcast-text {
    white-space: nowrap;
    font-weight: 900;
    font-size: 22px;
    text-shadow: 2px 2px 0px #000; 
    position: absolute;
    will-change: transform;
}
.effect-nika {
    background-color: #ffffff !important;
    animation: nika-heartbeat 0.8s ease-in-out infinite !important;
    height: 100vh;
    width: 100vw;
    overflow-x: hidden;
}

@keyframes nika-heartbeat {
    0% { 
        transform: scale(1); 
        filter: brightness(1);
    }
    10% { 
        transform: scale(1.03); 
        filter: brightness(1.2); 
    }
    100% { 
        transform: scale(1); 
        filter: brightness(1);
    }
}
.effect-system {
    animation: alert-shake 0.2s infinite !important;
    background-color: #ff0000 !important;
    background-image: radial-gradient(circle, rgba(0,0,0,0.5) 0%, transparent 70%) !important;
    color: white !important;
    z-index: 999;
}

@keyframes alert-shake {
    0% { transform: translate(0,0); }
    25% { transform: translate(5px, 5px); }
    50% { transform: translate(-5px, 5px); }
    75% { transform: translate(5px, -5px); }
    100% { transform: translate(0,0); }
}

.effect-cyber {
    filter: invert(1) hue-rotate(180deg) !important;
    background: #000 !important;
    transition: 0.1s;
}

.effect-rizz {
    animation: rizz-pulse 1s infinite !important;
    box-shadow: inset 0 0 100px #d4af37 !important;
    border: 5px solid #d4af37 !important;
}

@keyframes rizz-pulse {
    0% { filter: brightness(1) contrast(1.2); }
    50% { filter: brightness(1.5) contrast(1.5); }
    100% { filter: brightness(1) contrast(1.2); }
}
#flashbang-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: white;
    z-index: 999999; 
    display: none; 
    pointer-events: none;
}

.flash-active {
    display: block !important;
    animation: flash-out 2.5s forwards;
}

@keyframes flash-out {
    0% { opacity: 1; }
    30% { opacity: 1; }
    100% { opacity: 0; }
}
</style>
</style>
</head>
<body>
    
    

    <div id="student-alert-banner" style="display:none; position:fixed; top:0; left:0; width:100%; background:var(--accent); color:#000; padding:12px; text-align:center; font-weight:800; z-index:4000;">üì¢ UNIVERSITY ANNOUNCEMENT! Open the bell.</div>

     <audio id="splash-sound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg">
     </audio>

      <div id="splash-screen">
    <div id="falling-items-bg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none;"></div>
    <div class="splash-content">
        <img src="schedly-logo.png" 
             alt="Schedly Logo" 
             class="splash-logo">
        
        <h1 class="splash-text">SCHEDLY <span style="color:var(--accent)">PRO</span></h1>
        <div class="loader-bar">
            <div class="progress"></div>
        </div>
    </div>
</div>

<audio id="next-sound" preload="auto">
    <source src="next_effect.mp3" type="audio/mpeg">
</audio>

<audio id="btn-sound" preload="auto">
    <source src="button_click.mp3" type="audio/mpeg">
</audio>

<audio id="action-sound" preload="auto">
    <source src="action_effect.mp3" type="audio/mpeg">
</audio>

<audio id="notif-sound" preload="auto">
    <source src="notif.mp3" type="audio/mpeg">
</audio>

<audio id="task-alarm-sound" preload="auto" loop>
    <source src="task_alarm.mp3" type="audio/mpeg">
</audio>

      <audio id="bg-music" loop preload="auto">
    <source src="bg-music.mp3" type="audio/mpeg">
</audio>

<div id="music-touch" onclick="window.toggleMusic()" style="
    position: fixed !important; 
    bottom: 25px !important; 
    left: 20px !important; 
    width: 45px !important; 
    height: 45px !important; 
    background: #111 !important; 
    border: 2px solid #D4AF37 !important;
    border-radius: 12px !important; 
    display: flex !important; 
    align-items: center !important; 
    justify-content: center !important; 
    z-index: 999999 !important; /* Sobrang taas para laging nasa ibabaw */
    cursor: pointer !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;">
    <span id="music-icon" style="font-size: 20px !important; pointer-events: none;">üîá</span>
</div>

<div id="scr-shortcuts" class="view" style="display:none; background: #000; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; flex-direction: column;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; flex-shrink: 0;">
        
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0; padding: 0 15px;">
            <h2 style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-align: center; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                QUICK ACCESS
            </h2>
        </div>
        
        <div style="width: 45px; flex-shrink: 0;"></div>
    </div>

    <div style="text-align: center; padding: 15px 20px; background: linear-gradient(to bottom, #0a0a0a, #000); border-bottom: 1px solid #111; flex-shrink: 0;">
        <div style="color: #666; font-size: 10px; letter-spacing: 3px; text-transform: uppercase; opacity: 0.8;">Student Utilities</div>
    </div>

    <div id="shortcut-list-content" style="flex: 1; padding: 20px 20px 100px 20px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="nav-card" onclick="window.open('https://www.messenger.com', '_blank')" 
                 style="background: rgba(255,255,255,0.03); border: 1px solid rgba(0, 178, 255, 0.3); padding: 25px 10px; border-radius: 20px; text-align: center;">
                <div style="font-size: 35px; margin-bottom: 10px;">üí¨</div>
                <b style="display:block; color: white; font-size: 14px;">Messenger</b>
                <small style="color: #666; font-size: 10px;">Connect</small>
            </div>

            <div class="nav-card" onclick="window.open('https://classroom.google.com', '_blank')" 
                 style="background: rgba(255,255,255,0.03); border: 1px solid rgba(52, 168, 83, 0.3); padding: 25px 10px; border-radius: 20px; text-align: center;">
                <div style="font-size: 35px; margin-bottom: 10px;">üè´</div>
                <b style="display:block; color: white; font-size: 14px;">Classroom</b>
                <small style="color: #666; font-size: 10px;">Activities</small>
            </div>

            <div class="nav-card" onclick="window.open('https://www.canva.com', '_blank')" 
                 style="background: rgba(255,255,255,0.03); border: 1px solid rgba(139, 61, 255, 0.3); padding: 25px 10px; border-radius: 20px; text-align: center;">
                <div style="font-size: 35px; margin-bottom: 10px;">üé®</div>
                <b style="display:block; color: white; font-size: 14px;">Canva</b>
                <small style="color: #666; font-size: 10px;">Design/PPT</small>
            </div>

            <div class="nav-card" onclick="window.open('https://chatgpt.com', '_blank')" 
                 style="background: rgba(255,255,255,0.03); border: 1px solid rgba(116, 170, 156, 0.3); padding: 25px 10px; border-radius: 20px; text-align: center;">
                <div style="font-size: 35px; margin-bottom: 10px;">ü§ñ</div>
                <b style="display:block; color: white; font-size: 14px;">ChatGPT</b>
                <small style="color: #666; font-size: 10px;">AI Tutor</small>
            </div>

            <div class="nav-card" onclick="window.open('https://scholar.google.com', '_blank')" 
                 style="background: rgba(255,255,255,0.03); border: 1px solid rgba(66, 133, 244, 0.3); padding: 25px 10px; border-radius: 20px; text-align: center;">
                <div style="font-size: 35px; margin-bottom: 10px;">üìö</div>
                <b style="display:block; color: white; font-size: 14px;">Scholar</b>
                <small style="color: #666; font-size: 10px;">Research</small>
            </div>

            <div class="nav-card" onclick="window.open('https://www.photopea.com', '_blank')" 
                 style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255, 187, 51, 0.3); padding: 25px 10px; border-radius: 20px; text-align: center;">
                <div style="font-size: 35px; margin-bottom: 10px;">üñºÔ∏è</div>
                <b style="display:block; color: white; font-size: 14px;">Photopea</b>
                <small style="color: #666; font-size: 10px;">Editor</small>
            </div>
        </div>
        
        <p style="color: #444; text-align: center; font-size: 10px; margin-top: 30px; font-style: italic;">Links open in a new tab.</p>
    </div>
</div>

   <div id="scr-schedules-list" class="view" style="display:none; background: #000; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; flex-direction: column;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; margin-top: 0; flex-shrink: 0;">
        
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0; padding: 0 15px;">
            <h2 style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-align: center; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                SCHEDULES
            </h2>
        </div>
        
        <div style="width: 45px; flex-shrink: 0;"></div>
    </div>

    <div style="text-align: center; padding: 25px 20px; background: linear-gradient(to bottom, #0a0a0a, #000); border-bottom: 1px solid #111;">
        <div id="live-clock" style="font-size: 35px; font-weight: 900; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px;">00:00:00</div>
        <div id="live-date" style="color: var(--accent); font-size: 10px; letter-spacing: 3px; text-transform: uppercase; margin-top: 5px; opacity: 0.8;">February 10, 2026</div>
    </div>

    <div id="schedule-list-content" style="flex: 1; padding: 15px 20px 100px 20px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        </div>
</div>

<div id="scr-study" class="view" style="display: none; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; flex-direction: column;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; margin-top: 0; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0;">
            <h3 style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;">
                STUDY MODE
            </h3>
        </div>
        
        <div style="width: 45px; flex-shrink: 0;"></div>
    </div>

    <div style="text-align: center; padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: center;">
        
        <div style="background: #111; padding: 35px 20px; border-radius: 30px; border: 1px solid #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; box-sizing: border-box;">
            
            <div id="timer-input-wrapper">
                <input type="number" id="custom-min" value="25" min="1" max="120" 
                       style="background: none; border: none; color: var(--accent); font-size: 60px; font-weight: 800; width: 100%; text-align: center; outline: none; font-family: 'Courier New', monospace;">
                <p style="color: var(--accent); font-weight: bold; margin-top: -5px; font-size: 11px; letter-spacing: 3px; text-transform: uppercase;">MINUTES</p>
            </div>

            <h1 id="timer-display" style="display: none; color: var(--accent); font-size: 60px; font-weight: 800; margin: 10px 0; font-family: 'Courier New', monospace;">25:00</h1>
    
            <p id="timer-status" style="color: #666; margin: 20px 0; font-size: 12px; letter-spacing: 1px;">Set your focus goal</p>

            <div style="display: flex; gap: 12px; justify-content: center; width: 100%;">
                <button id="timer-btn" onclick="toggleTimer()" style="background: var(--success); color: black; border: none; padding: 15px 0; border-radius: 15px; font-weight: 800; cursor: pointer; flex: 1; font-size: 14px; letter-spacing: 1px;">START</button>
                <button onclick="resetTimer()" style="background: #222; color: white; border: 1px solid #444; padding: 15px 0; border-radius: 15px; cursor: pointer; flex: 1; font-size: 14px; letter-spacing: 1px;">RESET</button>
            </div>
        </div>
        
        <p style="margin-top: 30px; color: #444; font-size: 11px; font-style: italic; padding: 0 30px; line-height: 1.6;">"Stay focused, your future self will thank you."</p>
    </div>
</div>

<div id="scr-notes" class="view" style="display: none; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; flex-direction: column;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; margin-top: 0; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        
        <button onclick="exitNotes()" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0;">
            <h3 id="notes-title" style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;">
                MY LAB NOTES
            </h3>
        </div>

        <button onclick="createNewNote()" id="add-note-btn" style="background: var(--accent); color: black; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; outline: none;">
            +
        </button>
    </div>

    <div id="notes-list-container" style="flex: 1; padding: 15px; overflow-y: auto; display: block; -webkit-overflow-scrolling: touch;">
        <div id="notes-grid" style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); padding-bottom: 30px;">
            </div>
    </div>

    <div id="notes-editor-container" style="flex: 1; padding: 15px; display: none; flex-direction: column; background: #000;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px; padding: 10px; background: #111; border-radius: 15px; align-items: center; border: 1px solid #222;">
            <button onclick="formatNote('bold')" style="font-weight: bold; width: 35px; height: 35px; background: #222; color: white; border: none; border-radius: 8px; font-size: 14px;">B</button>
            <button onclick="formatNote('italic')" style="font-style: italic; width: 35px; height: 35px; background: #222; color: white; border: none; border-radius: 8px; font-size: 14px;">I</button>
            <div style="position: relative; width: 35px; height: 35px; border-radius: 8px; overflow: hidden; border: 1px solid #333;">
                <input type="color" onchange="formatNote('foreColor', this.value)" style="position: absolute; top: -5px; left: -5px; width: 50px; height: 50px; border: none; background: none; cursor: pointer;">
            </div>
            <button onclick="deleteCurrentNote()" style="margin-left: auto; background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 11px; font-weight: bold; text-transform: uppercase;">Delete</button>
        </div>
        
        <input type="text" id="edit-note-title" oninput="saveCurrentNote()" placeholder="Note Title..." 
               style="background: none; border: none; border-bottom: 1px solid #222; color: var(--accent); font-size: 20px; font-weight: 800; margin-bottom: 15px; outline: none; padding: 10px 0; width: 100%;">
        
        <div id="edit-note-body" contenteditable="true" 
             style="flex: 1; color: #ccc; font-size: 15px; outline: none; line-height: 1.6; overflow-y: auto; padding-bottom: 40px;" oninput="saveCurrentNote()"></div>
    </div>
</div>

   <div id="scr-peer" class="view" style="display: none; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; flex-direction: column;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; margin-top: 0; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0;">
            <h3 style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;">
                PEER BOARD
            </h3>
        </div>

        <div style="width: 45px; flex-shrink: 0;"></div> 
    </div>

    <div style="padding: 15px; background: #111; margin: 15px; border-radius: 20px; border: 1px solid #222; flex-shrink: 0;">
        <textarea id="peer-input" placeholder="What's happening on campus? Post it here..." 
            style="width: 100%; height: 65px; background: none; border: none; color: white; outline: none; resize: none; font-family: inherit; font-size: 14px; padding: 5px; box-sizing: border-box;"></textarea>
        
        <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px; padding-left: 5px;">
            <label style="cursor: pointer; font-size: 22px;" title="Add Photo">
                üì∑
                <input type="file" id="imgUpload" accept="image/*" style="display: none;" onchange="window.previewImg(this)">
            </label>

            <div id="imgPreviewCont" style="display: none; position: relative;">
                <img id="imgPreview" src="" style="height: 45px; width: 45px; border-radius: 8px; object-fit: cover; border: 2px solid var(--accent);">
                <span onclick="window.removeImg()" style="position: absolute; top: -8px; right: -8px; background: #ff4444; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; font-weight: bold;">&times;</span>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
            <div id="image-upload-indicator" style="color: #666; font-size: 11px; font-style: italic;"></div>
            
            <button onclick="addPost()" style="background: var(--accent); color: black; border: none; padding: 10px 25px; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 12px; letter-spacing: 1px;">POST</button>
        </div>
    </div>

    <div id="peer-posts-container" style="flex: 1; padding: 0 15px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; -webkit-overflow-scrolling: touch;">
    </div>
</div>

<div id="scr-about" class="view" style="display:none; flex-direction: column; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; margin-top: 0; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 0; padding: 0 10px;">
            <h2 style="margin:0; font-size: 16px; color: #fff; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;">ABOUT US</h2>
            <p style="margin:0; font-size: 9px; color: var(--accent); font-weight: 800; letter-spacing: 1px;">SCHEDLY PRO v1.0</p>
        </div>

        <div style="width: 45px; flex-shrink: 0;"></div>
    </div>

    <div style="padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch;">
        
        <div style="background: #0a0a0a; border: 1px solid #222; padding: 25px; border-radius: 24px; margin-bottom: 25px; border-left: 4px solid var(--accent);">
    
    <div style="margin-bottom: 20px;">
        <h2 style="color: var(--accent); margin: 0; font-size: 20px; font-weight: 900; letter-spacing: 0.5px; text-transform: uppercase;">
            SCHEDLY PRO V.1
        </h2>
        <p style="color: #666; margin: 5px 0 0; font-size: 10px; text-transform: uppercase; letter-spacing: 2px;">Your ultimate academic companion</p>
    </div>

    <div style="color: #ccc; font-size: 13px; line-height: 1.7;">
        <p style="margin: 0 0 20px 0;">
            <b>Hello, Fellow Students! üëã</b><br>
            We developed <b>SCHEDLY PRO</b> for our <b>Entrepreneurship subject</b> because we know how tough it is to balance academic life. Our goal is to give you a digital home where everything is in one place.
        </p>

        <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 18px; border: 1px solid #111; margin-bottom: 20px;">
            <p style="margin: 0; color: #aaa; font-size: 12.5px;">
                Whether you're tracking deadlines with <span style="color: var(--accent); font-weight: 700;">TASKS</span>, 
                checking your room in <span style="color: var(--accent); font-weight: 700;">SCHEDULES</span>, 
                monitoring your GWA through the <span style="color: var(--accent); font-weight: 700;">GRADE CALC</span>, 
                or staying focused with <span style="color: var(--accent); font-weight: 700;">STUDY MODE</span>we've got you covered. 
                Keep personal records in <span style="color: var(--accent); font-weight: 700;">MY NOTES</span>, 
                stay updated via the <span style="color: var(--accent); font-weight: 700;">PEER BOARD</span>, 
                and access essential tools instantly through <span style="color: var(--accent); font-weight: 700;">SHORTCUTS</span>.
            </p>
        </div>

        <p style="margin: 0 0 20px 0;">
            <b>Our Solution:</b> We created this centralized hub so you don't have to jump between scattered apps. We simplify the student journey so you can focus more on learning and less on tracking.
        </p>

        <p style="margin: 0; padding-top: 15px; border-top: 1px solid #1a1a1a; color: #888; font-style: italic; font-size: 12px;">
            Built by students, for students. We're here to make your academic life a little bit easier.
        </p>
    </div>

    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; opacity: 0.5;">
        <span style="color: #444; font-size: 9px; text-transform: uppercase; letter-spacing: 1px;">Entrepreneurship Project</span>
        <span style="color: var(--accent); font-size: 11px; font-weight: 800;">#StudentFirst</span>
    </div>
</div>

        <div style="background: #0d0d0d; border: 1px solid #1a1a1a; padding: 20px; border-radius: 24px; margin-bottom: 25px; text-align: center;">
            <p style="color: #666; font-size: 11px; margin-bottom: 15px; font-weight: 800; letter-spacing: 1px;">CONNECT WITH US</p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="https://www.facebook.com/profile.php?id=61586943834900" target="_blank" style="text-decoration: none; background: #1877F2; color: white; padding: 12px; border-radius: 12px; font-size: 12px; font-weight: bold; display: block;">FB PAGE</a>
                <a href="mailto:YourSchedly@gmail.com" style="text-decoration: none; background: #222; color: white; padding: 12px; border-radius: 12px; font-size: 11px; border: 1px solid #333; display: block; word-break: break-all;">YourSchedly@gmail.com</a>
                <a href="tel:+639928072368" style="text-decoration: none; background: #222; color: white; padding: 12px; border-radius: 12px; font-size: 11px; border: 1px solid #333; display: block;">+639928072368</a>
            </div>
        </div>

        <p style="color: #444; font-size: 11px; font-weight: 800; letter-spacing: 2px; margin-bottom: 15px; text-align: center; text-transform: uppercase;">MEET THE DEVELOPERS</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="grid-column: span 2; background: #111; border: 1px solid var(--accent); padding: 15px; border-radius: 20px; display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--accent); color: black; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px;">SJ</div>
                <div>
                    <h4 style="margin:0; color: white; font-size: 14px;">STEPHEN JOHN O. JAYNOS</h4>
                    <p style="margin:0; font-size: 10px; color: var(--accent); font-weight: bold;">Lead Developer / UI Designer</p>
                </div>
            </div>

            <div style="background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">JOHN JOSHUA SUMILANG</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
            <div style="background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">ALEXANDRA VILLASIS</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
            <div style="background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">ARBY CASTILLO</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
            <div style="background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">ARVIE ARSENIA</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
            <div style="background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">CHRISTIAN A. SIBOLINO</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
            <div style="background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">CYRUZ AMARO</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
            <div style="grid-column: span 2; background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; text-align: center;">
                <h4 style="color: white; font-size: 11px; margin: 0;">FARHAN PANINGBATAN</h4>
                <p style="color: #555; font-size: 9px; margin: 0;">Developer</p>
            </div>
        </div>

        <p style="text-align: center; color: #333; font-size: 9px; margin-top: 40px; font-weight: bold; letter-spacing: 1px;">&copy; 2026 SCHEDLY PRO. ALL RIGHTS RESERVED.</p>
    </div>
</div>

  <div id="scr-login" class="view" style="display:none;">
    <div class="auth-box" style="padding: 40px 20px; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5);">
        <div style="text-align: center; margin-bottom: 30px;">
            
            <img src="schedly-logo.png" 
                 alt="Schedly Logo" 
                 onerror="this.src='https://cdn-icons-png.flaticon.com/512/2693/2693507.png'"
                 style="width: 150px; height: auto; display: inline-block; margin-bottom: 15px; filter: drop-shadow(0 0 15px rgba(212,175,55,0.4));">

            <h1 style="margin: 0; font-size: 28px; font-weight: 800; letter-spacing: 3px; color: #fff;">
                SCHEDLY <span style="color:var(--accent)">PRO</span>
            </h1>
            
            <p style="font-size: 11px; color: var(--accent); margin-top: 8px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; opacity: 0.9;">
                Your ultimate academic companion
            </p>
            
            <div style="width: 40px; height: 2px; background: var(--accent); margin: 15px auto; border-radius: 2px;"></div>
        </div>

        <div style="width: 100%; max-width: 280px; margin: 0 auto;">
           <input type="text" id="log-u" placeholder="Username" 
       autocapitalize="off" autocorrect="off" autocomplete="username" 
       style="margin-bottom: 10px;">

            <input type="password" id="log-p" placeholder="Password" 
       autocomplete="current-password" 
       style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 280px; margin: 10px auto; font-size: 11px; color: #888;">
            <label style="display: flex; align-items: center; cursor: pointer; gap: 4px; user-select: none;">
                <input type="checkbox" id="log-remember" style="margin: 0; width: 14px; height: 14px; accent-color: var(--accent);"> 
                <span>Remember Me</span>
                </label>
         <span onclick="openSupport()" style="color: var(--accent); cursor: pointer; text-decoration: underline;">Ask for Assistance?</span>
        </div>
            <button class="btn" onclick="handleLogin()" style="width: 100%;">Sign In</button>
            
            <p onclick="showView('scr-reg')" style="color:gray; cursor:pointer; font-size:11px; margin-top:25px; text-align: center;">
                Don't have an account? <span style="color:var(--accent); font-weight: bold;">REGISTER</span>
            </p>
        </div>
    </div>
</div>

    <div id="scr-reg" class="view">
    <div class="auth-box">
        <h2>CREATE ACCOUNT</h2>
        <input type="text" id="reg-n" placeholder="Full Name">
        <input type="text" id="reg-u" placeholder="Username">
        <input type="tel" id="reg-phone" placeholder="Contact Number" maxlength="11">

        <input type="text" id="reg-address" placeholder="Home Address (City/Province)">

        <div style="display: flex; gap: 10px; width: 100%; margin-top: 10px;">
            <div style="flex: 1.2; text-align: left;">
                <label style="font-size: 10px; color: #aaa;">Birthdate</label>
                <input type="date" id="reg-birthdate" style="width: 100%; margin-top: 5px;">
            </div>
            
            <div style="flex: 1; text-align: left;">
                <label style="font-size: 10px; color: #aaa;">Gender</label>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <label class="gender-option">
                        <input type="radio" name="reg-gender" value="Male" checked>
                        <div class="gender-card">‚ôÇÔ∏è</div>
                    </label>
                    <label class="gender-option">
                        <input type="radio" name="reg-gender" value="Female">
                        <div class="gender-card">‚ôÄÔ∏è</div>
                    </label>
                </div>
            </div>
        </div>

        <select id="reg-level" style="margin-top: 15px;">
            <option value="" disabled selected>Select Academic Level</option>
            <option value="Grade 11">Grade 11</option>
            <option value="Grade 12">Grade 12</option>
            <option value="College">College</option>
        </select>

        <input type="email" id="reg-e" placeholder="Email Address">
        <input type="password" id="reg-p" placeholder="Password">
        <input type="password" id="reg-cp" placeholder="Confirm Password">

        <div class="terms-wrapper">
    <input type="checkbox" id="reg-agree" onclick="handleTermsClick(event)">
    <label for="reg-agree">I agree to the <span style="color: var(--accent); text-decoration: underline;">Terms & Conditions</span></label>
         </div> 

        <button class="btn" onclick="handleRegister()">Register</button>
        <p onclick="showView('scr-login')" style="cursor:pointer; font-size:11px; margin-top: 10px;">BACK</p>
    </div>
</div>
  
<div id="scr-student" class="view">
    <div class="main-panel" style="padding: 0;">
        
        <div style="width: 100%; padding: 8px 20px; display: flex; justify-content: flex-end; align-items: center; box-sizing: border-box;">
            <div class="status-indicator" style="margin: 0;">
                <div id="global-badge" class="badge online" style="padding: 4px 8px; font-size: 9px; display: flex; align-items: center; gap: 5px; border-radius: 12px; background: rgba(0,255,0,0.1); border: 1px solid var(--success);">
                    <div class="dot" style="width: 5px; height: 5px; background: var(--success); border-radius: 50%;"></div>
                    <span id="global-status-text" style="color: var(--success); font-weight: bold; text-transform: uppercase;">Online</span>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 20px; box-sizing: border-box;">
            <div style="text-align: left; min-width: 0;">
                <h1 style="font-size: 22px; margin: 0; color: var(--accent); font-weight: 800; white-space: nowrap; letter-spacing: -0.5px;">
                    SCHEDLY PRO V.1
                </h1>
                <p style="font-size: 10px; color: #666; letter-spacing: 0.5px; margin: 2px 0 0 0; white-space: nowrap;">
                    Your ultimate academic companion
                </p>
            </div>
            
            <div style="position: relative; cursor: pointer; padding: 5px; display: flex; align-items: center; z-index: 1100;" onclick="window.openNotifications()">
                <span style="font-size: 22px;">üîî</span>
                <span id="notif-count" style="display:none; position: absolute; top: -2px; right: -2px; background: #ff5f57; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #000;">0</span>
            </div>
        </div>

        <div class="main-grid" style="padding: 0 20px;">
            <div class="nav-card full-span" style="grid-column: span 2; border-color: var(--accent); background: linear-gradient(135deg, #111, #080808); margin-bottom: 5px;" onclick="openProfile()">
                <div style="display:flex; align-items:center; gap:15px; padding: 15px;">
                    <div id="user-initial" style="width:55px; height:55px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; color:black; font-weight:900; font-size:22px; box-shadow: 0 0 15px rgba(212,175,55,0.2);">?</div>
                    <div style="min-width: 0;">
                        <b id="dash-user-name" style="margin:0; font-size:16px; display:block; color: #fff;">Loading...</b>
                        <small id="dash-user-strand" style="display:block; color: var(--accent);">Personal Information</small>
                    </div>
                </div>
            </div>

            <div class="nav-card" onclick="openTasks()" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px; position: relative;">
    <span id="task-badge" style="position: absolute; top: 10px; right: 20px; background: #ff4444; color: white; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 50%; display: none; justify-content: center; align-items: center; border: 2px solid #000;">0</span>
    
    <span class="card-icon" style="font-size: 28px;">üìã</span>
    <b style="font-size: 14px;">Tasks</b>
    <small style="font-size: 10px; color: #666;">Reminders</small>
</div>

            <div class="nav-card" onclick="openSchedules()" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px; position: relative;">
    <span id="sched-badge" style="position: absolute; top: 10px; right: 20px; background: var(--accent, #d4af37); color: white; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 50%; display: none; justify-content: center; align-items: center; border: 2px solid #000;">0</span>
    
    <span class="card-icon" style="font-size: 28px;">‚è∞</span>
    <b style="font-size: 14px;">Schedules</b>
    <small style="font-size: 10px; color: #666;">Room & Time</small>
</div>
               
            <div class="nav-card" onclick="openGradeCalc()" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px;">
                <span class="card-icon" style="font-size: 28px;">üßÆ</span>
                 <b style="font-size: 14px;">Grade Calc</b>
                 <small style="font-size: 10px; color: #666;">GWA Tracker</small>
           </div>

            <div class="nav-card" onclick="openStudyMode()" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px;">
                <span class="card-icon" style="font-size: 28px;">‚è≥</span>
                <b style="font-size: 14px;">Study Mode</b>
                <small style="font-size: 10px; color: #666;">Focus Timer</small>
            </div>

            <div class="nav-card" onclick="showView('scr-notes'); renderNotes();" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px;">
                <span class="card-icon" style="font-size: 28px;">üóíÔ∏è</span>
                <b style="font-size: 14px;">My Notes</b>
                <small style="font-size: 10px; color: #666;">Personal Lab</small>
            </div>

            <div class="nav-card" onclick="showView('scr-peer'); renderPosts();" style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px;">
    <span class="card-icon" style="font-size: 28px;">ü§ù</span>
    <b style="font-size: 14px;">Peer Board</b>
    <small style="font-size: 10px; color: #666;">Market/Borrow</small>

    <div id="peerBadge" style="
        display: none; 
        position: absolute; 
        top: 8px; 
        right: 15px; 
        background: #ff4757; 
        color: white; 
        font-size: 10px; 
        font-weight: 800; 
        padding: 2px 6px; 
        border-radius: 10px; 
        border: 2px solid #1a1a1a;
        box-shadow: 0 0 10px rgba(255, 71, 87, 0.4);
    ">0</div>
</div>
            <div class="nav-card" onclick="openAbout()" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px;">
                <span class="card-icon" style="font-size: 28px;">‚ÑπÔ∏è</span>
                <b style="font-size: 14px;">About Us</b>
                <small style="font-size: 10px; color: #666;">Project Overview</small>
            </div>
             
            <div class="nav-card" onclick="openShortcuts()" style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 20px;">
                <span class="card-icon" style="font-size: 28px;">üîó</span>
                <b style="font-size: 14px;">Shortcuts</b>
                <small style="font-size: 10px; color: #666;">Quick Access</small>
            </div>

            <div class="nav-card full-span" style="grid-column: span 2; border-color: #333; background: rgba(255,95,87,0.05); padding: 15px;" onclick="triggerLogout()">
                <b style="color:var(--error); margin:0; width:100%; text-align:center; font-size: 13px; letter-spacing: 1px;">üö™ LOGOUT SYSTEM</b>
            </div>

        </div>
    </div>
</div>

<div id="scr-activate" class="view" style="display:none; overflow-y: auto;">
    <div class="auth-box" style="padding: 30px 20px; margin-top: 20px;">
        <h2 style="color: var(--accent); letter-spacing: 2px; font-weight: 800; margin-bottom: 10px;">ACTIVATE ACCOUNT</h2>
        <p style="font-size:12px; color:gray; margin-bottom:20px; line-height: 1.4;">
            Please enter your activation key or scan your QR card.
        </p>
        
        <div id="reader" style="width:100%; max-width: 250px; margin: 0 auto 15px; border-radius:15px; overflow:hidden; border: 2px solid rgba(212, 175, 55, 0.2); background: #000;"></div>
        
        <button id="cam-btn" class="btn" style="background:#1a1a1a; color:white; margin-bottom:20px; width: 100%; border: 1px solid #333;" onclick="startScanner()">
            üì∑ SCAN QR CODE
        </button>

        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <div style="flex: 1; height: 1px; background: #333;"></div>
            <span style="padding: 0 10px; color: #555; font-size: 10px; font-weight: bold;">OR ENTER MANUALLY</span>
            <div style="flex: 1; height: 1px; background: #333;"></div>
        </div>
        
        <input type="text" id="act-key" placeholder="SCH-XXXXXX" 
               style="text-align:center; letter-spacing:2px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">
        
        <button class="btn" onclick="verifyActivation()" style="width: 100%; box-shadow: 0 5px 15px rgba(212,175,55,0.2);">
            ACTIVATE NOW
        </button>
        
        <p onclick="location.reload()" style="color:#ff5f57; cursor:pointer; font-size:11px; margin-top:25px; font-weight: bold; letter-spacing: 1px;">
            CANCEL & LOGOUT
        </p>
    </div>
</div>

   <div id="scr-admin" class="view" style="padding:0;">
    <div class="admin-layout" style="display: flex; height: 100vh; width: 100vw; overflow: hidden;">
        
        <div class="sidebar" style="flex-shrink: 0;">
            <div class="nav-item active" onclick="admTab('dash', this)">‚öôÔ∏è</div>
            <div class="nav-item" onclick="admTab('ann', this)">üì¢</div>
            <div class="nav-item" onclick="admTab('keys', this)">üîë</div>
            <div class="nav-item" onclick="admTab('users', this)">üë•</div>
            <div class="nav-item" onclick="logoutSystem()">üö™</div>
        </div>

        <div class="main-panel" style="flex-grow: 1; overflow-y: auto; height: 100%; padding: 15px; box-sizing: border-box;">
            
            <div id="adm-dash" class="admin-card active">
                <h2>SYSTEM CONFIG</h2>
                <select id="sys-state">
                    <option value="normal">üü¢ ONLINE</option>
                    <option value="maintenance">üü° MAINTENANCE</option>
                    <option value="terminated">üî¥ TERMINATED</option> 
                </select>
                <input type="datetime-local" id="sys-time-end">
                <textarea id="sys-msg-in" placeholder="Message for students..."></textarea>
                <button class="btn" onclick="updateSys()">APPLY CHANGES</button>
            </div>
            
            <div id="adm-ann" class="admin-card">
                <h2>BROADCAST</h2>
                <textarea id="ann-msg-in" placeholder="Announcement message..."></textarea>
                
                <div style="margin: 15px 0;">
                    <label style="color: gray; font-size: 11px; display: block; margin-bottom: 5px;">EXPIRY DATE & TIME</label>
                    <input type="datetime-local" id="ann-time-end">
                </div>

                <button class="btn" style="width: 100%;" onclick="window.postAnnouncement()">LAUNCH BROADCAST</button>

                <hr style="border: 0; border-top: 1px solid #333; margin: 25px 0;">

                <h3>ACTIVE ANNOUNCEMENTS</h3>
                <div id="admin-ann-list"></div>
            </div> 

            <div id="adm-keys" class="admin-card">
                <h2>ACTIVATION KEYS</h2>
                <div class="stat-grid">
                    <div class="stat-item"><span id="count-key-unused">0</span><small>Valid</small></div>
                    <div class="stat-item"><span id="count-key-used" style="color:var(--error)">0</span><small>Used</small></div>
                </div>
                <button class="btn" onclick="genKey()">+ GENERATE KEY</button>
                
                <div id="key-card-container" style="display:none; margin-top:20px; text-align:center;">
                    <div id="capture-area" style="background:white; padding:20px; color:black; display:inline-block; border-radius:15px;">
                        <div id="qrcode-display"></div>
                        <h3 id="manual-code-text" style="font-family:monospace;"></h3>
                    </div><br>
                    <button class="btn" style="background:green; color:white; width:200px; margin-top:10px;" onclick="downloadKeyCard()">DOWNLOAD PNG</button>
                </div>
                <div id="list-keys-all" class="list-container" style="margin-top:20px;"></div>
            </div>

            <div id="adm-users" class="admin-card">
                <h2>STUDENT DATABASE</h2>
                <div class="stat-grid">
                    <div class="stat-item"><span id="count-stud-active">0</span><small>Active</small></div>
                    <div class="stat-item"><span id="count-stud-pending" style="color:var(--maint)">0</span><small>Pending</small></div>
                </div>
                <div id="list-users-all" class="list-container"></div>
            </div>
        </div> </div> </div>

    <div id="maint-screen">
        <div style="background:rgba(255,255,255,0.05); padding:40px; border-radius:30px; border:1px solid #333;">
            <div style="font-size:60px;">üõ†Ô∏è</div>
            <h2 id="maint-tag">SYSTEM OFFLINE</h2>
            <p id="m-msg" style="color:gray;"></p>
            <button class="btn" style="width:150px; margin-top:20px;" onclick="location.reload()">RECHECK</button>
        </div>
    </div>

    <div id="term-screen">
    <div style="background:rgba(255,95,87,0.05); padding:40px; border-radius:30px; border:1px solid var(--error); text-align:center; max-width:90%;">
        <div style="font-size:60px;">‚ö†Ô∏è</div>
        <h2 style="color:var(--error); margin-top:10px;">Application Session Concluded</h2>
        <p style="color:gray; font-size:14px; margin-bottom:25px;">Please contact your administrator for further information regarding this closure.</p>
        
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
            <button class="btn" style="width:220px; background:#1877f2; color:white;" onclick="window.location.href='YOUR_FB_LINK'">
                Visit FB Page
            </button>
            <button class="btn" style="width:220px; background:var(--accent); color:black;" onclick="window.location.href='YOUR_WEBSITE_LINK'">
                Visit Website
            </button>
        </div>
    </div>
</div>

<div id="scr-subjects" class="view" style="display:none; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; flex-direction: column;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; margin-top: 0; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0;">
            <h3 style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;">
                MY SUBJECTS
            </h3>
        </div>
        
        <button onclick="document.getElementById('subject-modal').style.display='flex'" style="background: var(--accent); color: black; border: none; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; outline: none;">
            +
        </button>
    </div>
    
    <div style="flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch;">
        <div id="subject-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 30px;">
            </div>
    </div>
</div>

<div id="scr-tasks" class="view" style="display:none; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; flex-direction: column; overflow: hidden;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        <button onclick="showView('scr-subjects')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; min-width: 0;">
            <h3 id="current-task-title" style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-align: center; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                TASKS
            </h3>
        </div>
        <div style="width: 45px; flex-shrink: 0;"></div>
    </div>

    <div style="padding: 15px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; box-sizing: border-box;">
        
        <div style="background: #111; padding: 15px; border-radius: 20px; border: 1px solid #222; margin-bottom: 20px; margin-top: 5px; box-sizing: border-box;">
            <input type="text" id="new-task-input" placeholder="What is your task?" 
                style="width: 100%; background: none; border: none; color: white; border-bottom: 1px solid #333; margin-bottom: 15px; padding: 8px 0; outline: none; font-size: 14px; box-sizing: border-box;">
            
            <div style="display: flex; gap: 8px; align-items: center; width: 100%; box-sizing: border-box;">
                <input type="datetime-local" id="task-deadline" 
                    style="background: #222; color: white; border: 1px solid #333; padding: 10px; border-radius: 12px; flex: 1; width: 0; min-width: 0; font-size: 11px; font-family: inherit; box-sizing: border-box; height: 42px; outline: none;">
                
                <button onclick="saveTask()" 
                    style="background: var(--accent); color: black; border: none; padding: 0 15px; border-radius: 10px; font-weight: 800; cursor:pointer; font-size: 11px; flex-shrink: 0; height: 42px; display: flex; align-items: center; justify-content: center;">
                    ADD
                </button>
            </div>
        </div>

        <div id="task-list-container" style="display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; width: 100%; box-sizing: border-box;">
            </div>
    </div>
</div>

<div id="subject-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3 style="color:white; margin-bottom:15px;">Create New Subject</h3>
        <input type="text" id="sub-name" placeholder="Subject Name (e.g. IT 101)" style="margin-bottom:10px;">
        <input type="text" id="sub-desc" placeholder="DATE / TIME / ROOM" style="margin-bottom:20px;">
        <div style="display: flex; gap: 10px;">
            <button onclick="saveSubject()" class="btn" style="background:var(--accent); color:black; font-weight:bold;">SAVE</button>
            <button onclick="document.getElementById('subject-modal').style.display='none'" class="btn" style="background:#333; color:white;">CANCEL</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal" style="display:none; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 10001; position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
   <div class="modal-content" style="max-width: 450px; width: 92%; background: #000; border: 1px solid #222; position: relative; padding: 20px; border-radius: 20px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; margin: auto;">
        
        <button onclick="closeModal('profile-modal')" style="position: absolute; right: 15px; top: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; z-index: 10;">&times;</button>
        
        <h3 style="color: var(--accent); margin: 0; text-align: center; font-size: 16px; letter-spacing: 2px;">PROFILE</h3>

        <div id="id-card-capture" style="background: linear-gradient(135deg, #111 0%, #000 100%); border: 1px solid var(--accent); border-radius: 15px; padding: 20px; position: relative; flex-shrink: 0;">
            <div style="display: flex; gap: 15px; align-items: center;">
                <div style="position: relative;">
                    <div class="avatar-wrapper" onclick="toggleActionMenu()" 
                         style="width: 65px; height: 65px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 2px solid var(--accent); background: var(--accent); display: flex; align-items: center; justify-content: center; position: relative; z-index: 1001;"> 
                        <div id="st-initials" style="font-size: 24px; font-weight: 800; color: #000;">?</div>
                        <img id="mainProfilePic" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>

                    <div id="actionMenu" style="display: none; position: absolute; background: #111; border: 1px solid #333; border-radius: 10px; top: 45px; left: 5px; z-index: 10005; width: 120px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); overflow: hidden;">
    
    <button onclick="document.getElementById('imageUploader').click(); toggleActionMenu();" 
            style="width: 100%; padding: 12px 10px; background: none; border: none; color: white; text-align: left; cursor: pointer; font-size: 9px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #222; white-space: nowrap; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
        <span style="font-size: 11px;">üì∑</span> CHANGE
    </button>
    
    <button onclick="removeProfilePic(); toggleActionMenu();" 
            style="width: 100%; padding: 12px 10px; background: none; border: none; color: #ff4444; text-align: left; cursor: pointer; font-size: 9px; display: flex; align-items: center; gap: 8px; white-space: nowrap; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
        <span style="font-size: 11px;">üóëÔ∏è</span> REMOVE
    </button>
</div>
                </div>

                <div style="flex: 1;">
    <h2 id="st-name" style="margin: 0; font-size: 16px; color: #fff; text-transform: uppercase;">LOADING...</h2>
    <p id="st-level" style="margin: 0; font-size: 11px; color: var(--accent);">-</p>
    <p id="bioDisplay" onclick="openBioEditor()" style="margin-top: 5px; font-size: 10px; color: #888; font-style: italic; cursor: pointer; border-bottom: 1px dashed #444; display: inline-block;">Tap to add bio...</p>
</div>
</div> 

<div style="margin-top: 15px; border-top: 1px solid #222; padding-top: 10px;">
    <p style="font-size: 10px; color: gray; margin: 2px 0;">USER: <span id="st-user" style="color: #fff;">-</span></p>
    <p style="font-size: 10px; color: gray; margin: 2px 0;">CONTACT: <span id="st-phone" style="color: #fff;">-</span></p>
</div>
<img id="st-mini-qr" src="" style="position: absolute; bottom: 15px; right: 15px; width: 45px; height: 45px; border: 1px solid #fff; border-radius: 4px; background: white;">
<input type="file" id="imageUploader" hidden accept="image/*" onchange="handleImageUpload(event)">
</div> <div style="background: #0a0a0a; padding: 15px; border-radius: 12px; border: 1px solid #1a1a1a; margin-top: 15px;">
    <p style="color: var(--accent); font-size: 10px; font-weight: bold; margin-bottom: 10px;">üë§ 1. PERSONAL INFORMATION</p>
    
    <label style="font-size: 9px; color: #555;">Full Name (Locked)</label>
    <input type="text" id="info-name" disabled style="width: 100%; background: #050505; color: #555; border: 1px solid #222; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
    
    <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end;">
    <div style="flex: 1; display: flex; flex-direction: column;">
        <label style="font-size: 9px; color: #555; min-height: 22px; display: flex; align-items: center;">
            Birthdate (Editable)
        </label>
        <input type="date" id="info-birthdate" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; box-sizing: border-box; height: 35px;">
    </div>
        <div style="flex: 1; display: flex; flex-direction: column;">
        <label style="font-size: 9px; color: #555; min-height: 22px; display: flex; align-items: center;">
            Gender (Editable)
        </label>
        <select id="info-gender" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; box-sizing: border-box; height: 35px;">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
    </div>
</div>

    <label style="font-size: 9px; color: #555;">Personal Contact (Editable)</label>
    <input type="tel" id="info-personal-contact" placeholder="09xxxxxxxxx" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; margin-bottom: 8px;">

    <label style="font-size: 9px; color: #555;">Email Address (Editable)</label>
    <input type="email" id="info-email" placeholder="Email" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
    
    <label style="font-size: 9px; color: #555;">Home Address (Editable)</label>
    <textarea id="info-address" rows="2" placeholder="Complete Address" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; resize: none;"></textarea>
</div>

        <div style="background: #0a0a0a; padding: 15px; border-radius: 12px; border: 1px solid #1a1a1a;">
            <p style="color: var(--accent); font-size: 10px; font-weight: bold; margin-bottom: 10px;">üè´ 2. SCHOOL INFORMATION</p>
            <label style="font-size: 9px; color: #555;">School Name (Editable)</label>
            <input type="text" id="info-school" placeholder="School Name" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <label style="font-size: 9px; color: #555;">Level (Locked)</label>
                    <input type="text" id="info-level" disabled style="width: 100%; background: #050505; color: #555; border: 1px solid #222; padding: 8px; border-radius: 6px;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 9px; color: #555;">Section Editable</label>
                    <input type="text" id="info-section" disabled style="width: 100%; background: #050505; color: #555; border: 1px solid #222; padding: 8px; border-radius: 6px;">
                </div>
            </div>
            <label style="font-size: 9px; color: #555;">Strand / Course (Editable)</label>
            <input type="text" id="info-strand" placeholder="e.g. STEM" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px;">
        </div>

        <div style="background: #0a0a0a; padding: 15px; border-radius: 12px; border: 1px solid #1a1a1a;">
            <p style="color: var(--accent); font-size: 10px; font-weight: bold; margin-bottom: 10px;">üö® 3. EMERGENCY CONTACTS</p>
            <div style="margin-bottom: 10px;">
                <label style="font-size: 8px; color: #444;">PERSON 1</label>
                <input type="text" id="info-guardian-1" placeholder="Guardian 1" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; margin-bottom: 5px;">
                <input type="tel" id="info-emergency-1" placeholder="Phone Number" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px;">
            </div>
            <div>
                <label style="font-size: 8px; color: #444;">PERSON 2</label>
                <input type="text" id="info-guardian-2" placeholder="Guardian 2" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px; margin-bottom: 5px;">
                <input type="tel" id="info-emergency-2" placeholder="Phone Number" style="width: 100%; background: #000; color: #fff; border: 1px solid #222; padding: 8px; border-radius: 6px;">
            </div>
        </div>

        <div style="background: #0a0a0a; border-radius: 12px; border: 1px solid #1a1a1a; padding: 10px;">
            <p style="color: var(--accent); font-size: 11px; font-weight: bold; margin-bottom: 8px;">üìç LIVE LOCATION</p>
            <div id="map-container" style="height: 180px; width: 100%; border-radius: 10px; background: #111; border: 1px solid #222;"></div>
        </div>

        <button onclick="saveStudentInformation()" style="width: 100%; padding: 15px; background: var(--accent); color: #000; font-weight: 800; border: none; border-radius: 12px; cursor: pointer;">üíæ SAVE UPDATES</button>
    </div>
</div>

      <div id="notif-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 10000; padding: 20px; backdrop-filter: blur(10px);">
    <div style="max-width: 500px; margin: 0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px; border-bottom: 1px solid #222; padding-bottom: 15px;">
            <div>
                <h2 style="color:var(--accent); margin:0; font-size: 20px;">Announcements</h2>
                <small style="color: gray;">Real-time school updates</small>
            </div>
            <button onclick="document.getElementById('notif-overlay').style.display='none'" style="background:#222; border:none; color:white; width: 35px; height: 35px; border-radius: 50%; font-size:18px; cursor: pointer;">‚úï</button>
        </div>
        
        <div id="notif-list-container" style="overflow-y: auto; max-height: 75vh; padding-right: 5px;">
            <p style="color:gray; text-align:center; margin-top: 20px;">Checking for updates...</p>
        </div>
    </div>
</div>

<div id="global-announcement-banner" style="
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    z-index:9999; 
    padding:15px; 
    background:var(--accent); 
    color:black; 
    font-weight:bold; 
    text-align:center; 
    box-shadow:0 4px 15px rgba(0,0,0,0.5); 
    cursor:pointer;
    animation: slideDown 0.5s ease;">
    <span id="banner-text">üì¢ NEW ANNOUNCEMENT!</span>
    </div>


<div id="edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(5px); padding: 20px; box-sizing: border-box;">
    
    <div style="background:#111; padding:25px; border-radius:20px; width:100%; max-width:350px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        
        <h3 style="color: var(--accent); margin: 0 0 5px 0; font-size: 20px; letter-spacing: 1px; font-weight: 800;">EDIT STUDENT</h3>
        <p style="color: #666; font-size: 11px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">Update account information</p>

        <input type="hidden" id="edit-id">

        <div style="display: flex; flex-direction: column; gap: 12px;">
            <div>
                <label style="color: #444; font-size: 10px; font-weight: bold; margin-left: 5px;">FULL NAME</label>
                <input type="text" id="edit-name" placeholder="Juan Dela Cruz" style="width:100%; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; color:white; font-size: 14px; margin-top: 4px;">
            </div>

            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="color: #444; font-size: 10px; font-weight: bold; margin-left: 5px;">LEVEL</label>
                    <input type="text" id="edit-level" placeholder="Grade 12" style="width:100%; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; color:white; font-size: 14px; margin-top: 4px;">
                </div>
                <div style="flex: 2;">
                    <label style="color: #444; font-size: 10px; font-weight: bold; margin-left: 5px;">USERNAME</label>
                    <input type="text" id="edit-username" placeholder="Username" style="width:100%; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; color:white; font-size: 14px; margin-top: 4px;">
                </div>
            </div>

            <div>
                <label style="color: #444; font-size: 10px; font-weight: bold; margin-left: 5px;">CONTACT NUMBER</label>
                <input type="text" id="edit-phone" placeholder="09XXXXXXXXX" style="width:100%; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; color:white; font-size: 14px; margin-top: 4px;">
            </div>

            <div>
                <label style="color: #444; font-size: 10px; font-weight: bold; margin-left: 5px;">PASSWORD</label>
                <input type="password" id="edit-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; color:white; font-size: 14px; margin-top: 4px;">
                <small style="color: #444; font-size: 9px; margin-top: 4px; display: block; margin-left: 5px;">Leave blank to keep current password</small>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:25px;">
            <button type="button" onclick="saveStudentEdit()" style="flex:2; background:var(--accent); color:black; border:none; padding:15px; border-radius:12px; font-weight:800; cursor:pointer; font-size: 13px; text-transform: uppercase;">
                SAVE CHANGES
            </button>
            <button type="button" onclick="document.getElementById('edit-modal').style.display='none'" style="flex:1; background:transparent; color:#666; border:1px solid #333; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; font-size: 13px;">
                CANCEL
            </button>
        </div>
    </div>
</div>

<div id="logout-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center; backdrop-filter: blur(5px);">
    <div class="modal-content" style="background:#121212; border:1px solid #333; border-radius:24px; padding:30px; width:85%; max-width:320px; text-align:center; box-shadow: 0 20px 40px rgba(0,0,0,0.6);">
        <div style="font-size: 50px; margin-bottom: 15px;">üö™</div>
        <h2 style="color:var(--accent); margin-bottom: 10px; font-size: 22px;">Logging Out?</h2>
        <p style="color:#888; font-size: 14px; margin-bottom: 25px; line-height: 1.5;">Are you sure you want to end your session? You'll need to login again to access your schedules.</p>
        
        <div style="display:flex; flex-direction: column; gap: 10px;">
            <button onclick="confirmLogout()" style="width:100%; padding:14px; border-radius:12px; border:none; background:var(--error); color:white; font-weight:bold; font-size: 14px; cursor:pointer;">YES, LOGOUT</button>
            <button onclick="closeLogoutModal()" style="width:100%; padding:14px; border-radius:12px; border:none; background:transparent; color:#666; font-weight:bold; font-size: 14px; cursor:pointer;">CANCEL</button>
        </div>
    </div>
</div>

<div id="toast-container" style="
    position: fixed;
    bottom: 80px; 
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid var(--accent);
    color: white;
    padding: 12px 25px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: bold;
    z-index: 9999999;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
    opacity: 0;
    pointer-events: none;
    
    white-space: nowrap; 
    max-width: 85vw; 
    overflow: hidden;">
    
    <span id="toast-icon" style="flex-shrink: 0;">üëã</span>
    
    <span id="toast-message" style="
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: block;">
        Welcome Back, Student!
    </span>
</div>

<div id="welcome-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
    <div id="modal-content" style="background:#111; border:2px solid var(--accent); padding:25px; border-radius:24px; max-width:400px; width:90%; text-align:center; box-shadow: 0 0 30px rgba(0,0,0,0.5); position:relative; overflow:hidden;">
        <div id="modal-step-content">
            </div>
        <button id="modal-next-btn" style="margin-top:25px; background:var(--accent); color:black; border:none; padding:12px 30px; border-radius:12px; font-weight:800; width:100%; cursor:pointer;">NEXT</button>
    </div>
</div>

<div id="bio-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000000; justify-content:center; align-items:center; backdrop-filter:blur(5px);">
    <div style="background:#111; border:1px solid #D4AF37; width:85%; max-width:350px; padding:25px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="color:#D4AF37; margin-top:0; font-size:18px;">Update Bio</h3>
        <p style="color:#ccc; font-size:13px; margin-bottom:15px;">Write something about yourself:</p>
        
        <textarea id="bio-input" style="width:100%; height:100px; background:#1a1a1a; border:1px solid #333; border-radius:10px; color:white; padding:10px; font-family:inherit; resize:none; outline:none; margin-bottom:20px;" placeholder="Enter your bio..."></textarea>
        
        <div style="display:flex; gap:10px;">
            <button onclick="closeBioModal()" style="flex:1; background:#222; color:white; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">Cancel</button>
            <button onclick="confirmBioUpdate()" style="flex:1; background:#D4AF37; color:black; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">Save</button>
        </div>
    </div>
</div>

<div id="support-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000000; justify-content:center; align-items:center; backdrop-filter:blur(5px); padding: 15px; box-sizing: border-box;">
    <div style="background:#111; border:1px solid #D4AF37; width:100%; max-width:300px; padding:20px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        
        <h3 style="color:#D4AF37; margin-top:0; font-size:18px; margin-bottom: 5px;">Schedly Pro Support</h3>
        <p style="color:#ccc; font-size:12px; margin-bottom:20px;">How can we help you today?</p>
        
        <div style="display:flex; flex-direction:column; gap:10px;">
            
            <button onclick="window.open('https://www.facebook.com/profile.php?id=61586943834900', '_blank')" style="background:#1877F2; color:white; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; font-size: 14px;">
                <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 4px;">FB</span> 
                Facebook Support
            </button>

            <button onclick="window.open('tel:+639928072368')" style="background:#222; color:#D4AF37; border:1px solid #333; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; width: 100%; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span>üìû</span> +63 992 807 2368
            </button>

            <button onclick="window.location.href='mailto:YourSchedly@gmail.com'" style="background:#222; color:#D4AF37; border:1px solid #333; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; width: 100%; font-size: 12px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span>üìß</span> YourSchedly@gmail.com
            </button>

            <button onclick="showToast('Website is under maintenance.', '‚è≥')" style="background:#1a1a1a; color:#666; border:1px solid #333; padding:12px; border-radius:12px; font-weight:bold; cursor:not-allowed; font-size: 13px;">
                üåê Website (Soon)
            </button>
        </div>

        <button onclick="closeSupportModal()" style="margin-top:20px; background:transparent; color:#888; border:none; font-size:13px; text-decoration:underline; cursor:pointer; width: 100%;">Close</button>
    </div>
</div>

<div id="terms-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000001; justify-content:center; align-items:center; backdrop-filter:blur(10px);">
    <div style="background:#111; border:1px solid #D4AF37; width:90%; max-width:350px; padding:25px; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.8);">
        <h3 style="color:#D4AF37; margin-top:0; text-align:center;">WELCOME TO SCHEDLY PRO! üìù</h3>
        
        <div style="color:#ccc; font-size:14px; line-height:1.6; margin:20px 0; text-align:left;">
            <p style="margin-bottom:10px;">By checking this, you agree to:</p>
            <ul style="padding-left:20px; margin:0;">
                <li>Safe data storage in Firebase.</li>
                <li>Accurate ID information.</li>
                <li>Fair use of the system.</li>
            </ul>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="termsDecision(false)" style="flex:1; background:#222; color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">Decline</button>
            <button onclick="termsDecision(true)" style="flex:1; background:#D4AF37; color:black; border:none; padding:12px; border-radius:10px; font-weight:bold;">I Agree</button>
        </div>
    </div>
</div>

<div id="delete-confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000002; justify-content:center; align-items:center; backdrop-filter:blur(5px);">
    <div style="background:#111; border:1px solid #ff4444; width:85%; max-width:320px; padding:25px; border-radius:20px; text-align:center;">
        <h3 style="color:#ff4444; margin-top:0;">Remove Student?</h3>
        <p style="color:#ccc; font-size:14px; margin-bottom:20px;">Are you sure? This action cannot be undone and the student will lose access.</p>
        <div style="display:flex; gap:10px;">
            <button onclick="closeDeleteModal()" style="flex:1; background:#222; color:white; border:none; padding:12px; border-radius:12px; font-weight:bold;">Cancel</button>
            <button id="confirm-delete-btn" style="flex:1; background:#ff4444; color:white; border:none; padding:12px; border-radius:12px; font-weight:bold;">Remove</button>
        </div>
    </div>
</div>

<div id="task-delete-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000003; justify-content:center; align-items:center; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); padding: 20px; box-sizing: border-box;">
    
    <div class="modal-content" style="background:#1a1a1a; border:1px solid rgba(255,68,68,0.3); width:100%; max-width:320px; padding:24px; border-radius:24px; text-align:center; box-shadow: 0 15px 35px rgba(0,0,0,0.5);">
        
        <div style="font-size: 42px; margin-bottom: 12px;">üóëÔ∏è</div>
        <h3 style="color:#ffffff; margin:0 0 8px 0; font-size:1.3rem; font-family: sans-serif;">Remove Task?</h3>
        <p style="color:#a0a0a0; font-size:0.95rem; margin-bottom:28px; line-height:1.5; font-family: sans-serif;">This will delete the task from your list. Are you sure?</p>
        
        <div style="display:flex; gap:12px; flex-direction: row;">
            <button onclick="closeTaskDeleteModal()" style="flex:1; background:#333; color:white; border:none; height:50px; border-radius:14px; font-weight:600; font-size:1rem; cursor:pointer;">
                Cancel
            </button>
            <button id="confirm-task-del-btn" style="flex:1; background:#ff4444; color:white; border:none; height:50px; border-radius:14px; font-weight:bold; font-size:1rem; cursor:pointer; box-shadow: 0 4px 10px rgba(255,68,68,0.2);">
                Delete
            </button>
        </div>
    </div>
</div>

<div id="task-done-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000005; justify-content:center; align-items:center; backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); padding: 20px;">
    <div style="background:#1a1a1a; border:1px solid rgba(76, 217, 100, 0.4); width:100%; max-width:320px; padding:25px; border-radius:25px; text-align:center; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
        <div style="font-size: 45px; margin-bottom: 10px;">üèÜ</div>
        <h3 style="color:#fff; margin:0 0 10px 0; font-family:sans-serif;">Mission Done?</h3>
        <p style="color:#aaa; font-size:0.9rem; margin-bottom:25px; line-height:1.4;">Marking this task as completed. Good job on finishing your work!</p>
        <div style="display:flex; gap:12px;">
            <button onclick="window.closeTaskDoneModal()" style="flex:1; background:#333; color:white; border:none; height:50px; border-radius:15px; font-weight:600;">Cancel</button>
            <button id="confirm-task-done-btn" style="flex:1; background:#4cd964; color:#000; border:none; height:50px; border-radius:15px; font-weight:bold;">Yes, Done!</button>
        </div>
    </div>
</div>

<div id="note-delete-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999999; justify-content:center; align-items:center; backdrop-filter:blur(5px);">
    <div style="background:#1a1a1a; width:85%; max-width:300px; padding:20px; border-radius:20px; text-align:center; border:1px solid #444;">
        <div style="font-size: 40px; margin-bottom: 10px;">üìùüóëÔ∏è</div>
        <p style="color:white; margin-bottom:20px; font-weight:bold;">Delete this note?</p>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('note-delete-modal').style.display='none'" style="flex:1; padding:12px; border-radius:10px; border:none; background:#333; color:white;">Cancel</button>
            <button id="confirm-note-delete" style="flex:1; padding:12px; border-radius:10px; border:none; background:#ff4444; color:white; font-weight:bold;">Delete</button>
        </div>
    </div>
</div>

<div id="scr-grade-calc" class="view" style="display:none; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; flex-direction: column; overflow: hidden;">
    
    <div style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #222; background: #0a0a0a; flex-shrink: 0; height: 75px; box-sizing: border-box;">
        <button onclick="showView('scr-student')" style="background: #222; color: white; border: 1px solid #444; border-radius: 50%; width: 45px; height: 45px; cursor:pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; outline: none;">
            ‚Üê
        </button>
        <h3 style="color: var(--accent); margin: 0; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 2px;">GRADE CALC</h3>
        <div style="width: 45px;"></div>
    </div>

    <div style="padding: 20px; overflow-y: auto; flex: 1; box-sizing: border-box; -webkit-overflow-scrolling: touch;">
        
        <div style="background: #111; padding: 20px; border-radius: 20px; border: 1px solid #222; text-align: center; margin-bottom: 20px;">
            <p style="color: #666; font-size: 12px; margin-bottom: 5px; text-transform: uppercase;">Your Estimated GWA</p>
            <h1 id="gwa-result" style="color: var(--accent); font-size: 48px; margin: 0; font-weight: 900;">0.00</h1>
        </div>

        <div id="grade-inputs-container" style="width: 100%;">
            </div>
          
        <div style="display: flex; gap: 10px; margin-top: 15px; margin-bottom: 30px;">
            <button onclick="addSubjectRow()" style="flex: 1; background: none; border: 1px dashed #444; color: #888; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 12px;">
                + Add Subject
            </button>

            <button onclick="clearGrades()" style="flex: 1; background: rgba(255,95,87,0.1); border: 1px solid rgba(255,95,87,0.3); color: #ff5f57; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: bold;">
                üóëÔ∏è Clear All
            </button>
        </div>
    </div>

    <div style="padding: 20px; background: #0a0a0a; border-top: 1px solid #222; flex-shrink: 0;">
        <button onclick="calculateGWA()" style="width: 100%; background: var(--accent); color: black; border: none; padding: 15px; border-radius: 15px; font-weight: 900; font-size: 16px; cursor: pointer;">
            CALCULATE NOW
        </button>
    </div>
</div>
    
<div id="commentModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; backdrop-filter: blur(8px);">
    <div style="width:95%; max-width:450px; background:#0a0a0a; margin: 40px auto; border-radius:20px; border:1px solid #B8860B; display:flex; flex-direction:column; height:80vh; overflow:hidden;">
        
        <div style="padding:15px 20px; border-bottom:1px solid rgba(184,134,11,0.2); display:flex; justify-content:space-between; align-items:center;">
            <strong style="color:#FFD700; letter-spacing:1px; font-size:14px;">COMMENTS</strong>
            <button onclick="window.closeCommentModal()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div id="commentsList" style="
    flex: 1 !important; 
    overflow-y: auto !important; 
    padding: 15px !important; 
    background: #050505 !important; 
    display: block !important;       /* Binago mula flex pabalik sa block */
    text-align: left !important;     /* Siguradong sa kaliwa lahat */
    width: 100% !important;
">
    </div>

        <div style="padding:15px; background:#0a0a0a; border-top:1px solid rgba(255,255,255,0.05); display:flex; gap:10px;">
            <input id="commentInput" type="text" placeholder="Write a comment..." style="flex:1; background:#111; border:1px solid #333; color:#fff; padding:12px; border-radius:12px; outline:none; font-size:14px;">
            <button id="sendCommentBtn" style="background:#B8860B; border:none; color:#000; padding:0 20px; border-radius:12px; font-weight:900; cursor:pointer;">SEND</button>
        </div>
    </div>
</div>

<div id="peerUserModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100000; justify-content:center; align-items:center; -webkit-backdrop-filter:blur(5px); backdrop-filter:blur(5px);">
    <div style="background:#1a1a1a; width:85%; max-width:320px; border-radius:25px; padding:20px; border:1px solid rgba(255,255,255,0.1); text-align:center; position:relative;">
        
        <button onclick="closePeerModal()" style="position:absolute; right:15px; top:15px; background:none; border:none; color:#555; font-size:24px; cursor:pointer;">&times;</button>
        
        <div id="peerModalImgContainer" style="width:90px; height:90px; border-radius:50%; margin:10px auto 15px; padding:3px; background:linear-gradient(45deg, #FFD700, #FFA500); transition: all 0.3s ease;">
            <div style="width:100%; height:100%; border-radius:50%; overflow:hidden; background:#000;">
                <img id="peerModalImg" src="" style="width:100%; height:100%; object-fit:cover;">
            </div>
        </div>
        
        <h2 id="peerModalName" style="color:#fff; margin:0; font-size:18px; font-weight:800;"></h2>
        <p id="peerModalFullName" style="color:rgba(255,255,255,0.5); margin:2px 0 0; font-size:12px; font-style:normal;"></p>
        
        <p id="peerModalRole" style="font-size:10px; font-weight:900; margin:10px 0 15px; letter-spacing:1px; text-transform:uppercase;"></p>
        
        <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; margin-bottom:10px; border: 1px solid rgba(255,255,255,0.05);">
            <p id="peerModalBio" style="color:#bbb; font-size:12px; margin:0; line-height:1.4;"></p>
        </div>

        <div id="peerAdminControls" style="display:none; border-top:1px solid rgba(255,255,255,0.08); padding-top:15px; margin-top:15px;">
            <button id="peerMuteBtn" onclick="toggleMute()" style="width:100%; padding:14px; border-radius:15px; border:none; background:#ff4444; color:#fff; font-weight:900; font-size:12px; letter-spacing:1px; cursor:pointer; transition: 0.2s;">
                MUTE USER
            </button>
        </div>
    </div>
</div>


<div id="devAssistiveBtn" style="display:none; position:fixed; top:20%; right:15px; width:50px; height:50px; background:rgba(20,20,20,0.9); border:2px solid #FFD700; border-radius:50%; justify-content:center; align-items:center; z-index:999999; cursor:grab; box-shadow: 0 0 20px rgba(212,175,55,0.4); backdrop-filter:blur(10px); touch-action:none;">
    <span style="font-size:24px;">üõ†Ô∏è</span>
</div>

<div id="devPanelOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000000; justify-content:center; align-items:center; backdrop-filter:blur(8px);">
    <div style="background:#111; width:85%; max-width:340px; height:75vh; border-radius:30px; padding:25px; border:1px solid rgba(255,215,0,0.3); position:relative; display:flex; flex-direction:column; box-shadow: 0 0 30px rgba(0,0,0,0.5);">
        
        <div style="display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px;">
            <button onclick="switchDevTab('users')" style="background:none; border:none; color:#FFD700; font-weight:900; cursor:pointer; font-size:12px;">USERS</button>
            <button onclick="switchDevTab('broadcast')" style="background:none; border:none; color:#FFD700; font-weight:900; cursor:pointer; font-size:12px;">BROADCAST</button>
        </div>

        <button onclick="document.getElementById('devPanelOverlay').style.display='none'" style="position:absolute; right:20px; top:15px; background:none; border:none; color:#555; font-size:28px; cursor:pointer;">&times;</button>
        
        <div id="tab-users" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:12px;">
            <div id="devUserList" style="display:flex; flex-direction:column; gap:12px;">
                <p style="color:#555; text-align:center; font-size:12px;">Initializing users...</p>
            </div>
        </div>

        <div id="tab-broadcast" style="display:none; flex:1; flex-direction:column; gap:15px;">
            <h4 style="color:#FFD700; margin:0; font-size:14px; text-align:center; letter-spacing:1px;">SYSTEM OVERRIDE</h4>
            
            <textarea id="bc-input" placeholder="Type your long abuse message here..." 
                style="width:100%; height:100px; background:#000; border:1px solid #333; color:white; border-radius:15px; padding:10px; font-family:inherit; resize:none; outline:none; font-size:13px;"></textarea>

            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label style="color: #555; font-size: 10px; font-weight: 800; padding-left: 5px;">SELECT OVERRIDE MODE:</label>
                <select id="bc-effect" style="width:100%; background:#000; border:1px solid #333; color:#FFD700; border-radius:10px; padding:10px; font-size:12px; outline:none; cursor:pointer;">
                    <option value="normal">NORMAL (CLEAN)</option>
                    <option value="nika">‚òÄÔ∏è SUN GOD NIKA</option>
                    <option value="glitch">üëæ GLITCH SYSTEM</option>
                    <option value="rizz">üòè RIZZ MODE</option>
                    <option value="action">üî• ACTION (SCREEN SHAKE)</option>
                    <option value="flash">‚ö° FLASH BANG (WHITE BLIND)</option>
                </select>
            </div>
            
            <button onclick="handleBroadcastPush()" 
                style="background:#FFD700; color:black; border:none; padding:12px; border-radius:12px; font-weight:900; cursor:pointer; font-size:12px;">
                üöÄ PUSH BROADCAST
            </button>
            
            <button onclick="stopBroadcast()" 
                style="background:rgba(255,0,0,0.1); color:#ff4444; border:1px solid #ff4444; padding:10px; border-radius:12px; font-weight:800; cursor:pointer; font-size:11px;">
                üõë STOP ANNOUNCEMENT
            </button>

            <p style="color:#444; font-size:10px; text-align:center; font-style:italic;">Override status will be sent to all active users.</p>
        </div>
    </div>
</div>

<div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: pointer;" onclick="this.style.display='none'">
    <span style="position: absolute; top: 20px; right: 25px; color: white; font-size: 35px; font-weight: bold;">&times;</span>
    <img id="modalImg" style="max-width: 95%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
</div>

<div id="admin-broadcast-banner" style="display: none; position: fixed; top: 20px; left: 5%; width: 90%; height: 55px; z-index: 2147483647; background: rgba(0,0,0,0.9); border-radius: 50px; border: 1.5px solid gold; overflow: hidden; align-items: center; pointer-events: none;">
    <div style="width: 100%; overflow: hidden; display: flex; align-items: center; padding: 0 20px;">
        <div id="broadcast-text" style="display: inline-block; white-space: nowrap; font-weight: 900; font-size: 18px; color: gold; text-transform: uppercase;">
            </div>
    </div>
</div>

</style>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, addDoc, setDoc, deleteDoc, serverTimestamp, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.currentPostId = null;

    const firebaseConfig = {
        apiKey: "AIzaSyD_4YemXc1kELejpQizgg2AFeYiPDHUEGM",
        authDomain: "schedly-pro-178d5.firebaseapp.com",
        projectId: "schedly-pro-178d5",
        storageBucket: "schedly-pro-178d5.firebasestorage.app",
        messagingSenderId: "368476521535",
        appId: "1:368476521535:web:594cbdb4fb761c83ad648a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);


const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg'); 
const finalAlarm = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_beeping.ogg');
const adminCheerSound = new Audio('https://www.soundjay.com/human/sounds/applause-01.mp3');
adminCheerSound.load();
const peerCollection = collection(db, "peer_posts");
let selectedUserIdForAdmin = null;
let isReacting = false;
let lastPostTime = Date.now();
let notifiedPostIds = new Set();
let unreadCount = 0
let userRole = 'none';
let loggedInUserDoc = ""; 
let currentSubId = "";
let taskListener = null;
let timerInterval = null;
let audioCtx = null;
let timeLeft = 0;
let ringInterval = null;
let notes = JSON.parse(localStorage.getItem('schedly_notes_list')) || [];
let activeNoteId = null; 
let posts = JSON.parse(localStorage.getItem('schedly_posts')) || [];
let html5QrCode;
let isMusicActive = false;
let selectedImgFile = null; 
let abuseBGM = null;
async function uploadToCloudinary(file) {
    const cloudName = 'dp1hqckhq'; 
    const uploadPreset = 'ml_default'; 
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', uploadPreset);

    try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        return data.secure_url; 
    } catch (e) {
        console.error("Cloudinary Error:", e);
        return null;
    }
}

onSnapshot(peerCollection, (snapshot) => {
    const feed = document.getElementById('peer-feed');
    if (!feed) return;
    let allPosts = [];
    snapshot.forEach((doc) => { allPosts.push({ id: doc.id, ...doc.data() }); });
    allPosts.sort((a, b) => b.createdAt - a.createdAt);
    feed.innerHTML = '';
    const currentUser = loggedInUserDoc || JSON.parse(localStorage.getItem('user_data'));
    allPosts.forEach((post) => {
        const postDiv = document.createElement('div');
        postDiv.style = "background: #111; padding: 20px; border-radius: 20px; border: 1px solid #222; margin-bottom: 15px; position: relative; width: 100%; box-sizing: border-box;";
        const isOwner = currentUser && (currentUser.uid === post.senderId);
        const displayImg = (post.senderImg && post.senderImg !== "null") ? post.senderImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(post.senderName)}&background=random&color=fff`;
        postDiv.innerHTML = `<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><img src="${displayImg}" style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); flex-shrink: 0;"><div style="min-width: 0;"><div style="color: white; font-size: 14px; font-weight: 800;">@${post.senderName}</div><div style="color: #444; font-size: 10px;">${post.timeDisplay}</div></div></div><div style="color: #ccc; font-size: 15px;">${post.text}</div>${isOwner ? `<button onclick="deletePost('${post.id}')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #ff4444; font-size: 20px;">&times;</button>` : ''}`;
        feed.appendChild(postDiv);
    });
});

const playRingingSound = (stop = false) => {
    const taskAudio = document.getElementById('task-alarm-sound');

    if (stop) {
        if (ringInterval) { clearInterval(ringInterval); ringInterval = null; }
        if (audioCtx) { audioCtx.close(); audioCtx = null; }
        if (taskAudio) { taskAudio.pause(); taskAudio.currentTime = 0; }
        return;
    }


    if (taskAudio) {
        taskAudio.play().catch(e => {
            console.log("MP3 failed, using robotic backup.");

            startRoboticBeep();
        });
    } else {
        startRoboticBeep();
    }
};

function startRoboticBeep() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (!ringInterval) {
        ringInterval = setInterval(() => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }, 400); 
    }
}
setInterval(() => {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
    
    const q = query(collection(db, "student_tasks"), where("status", "!=", "completed"));
    
    getDocs(q).then(snap => {
        snap.forEach(d => {
            const t = d.data();
            if (t.deadline === localISOTime) {
                playRingingSound();
                
                const alarmModal = document.getElementById('deadline-alarm-modal');
                const taskNameLabel = document.getElementById('alarm-task-name');
                
                if (alarmModal && taskNameLabel) {
                    taskNameLabel.innerText = t.taskName;
                    alarmModal.style.display = 'flex';
                }

                if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);

                document.getElementById('stop-alarm-btn').onclick = () => {
                    playRingingSound(true); 
                    alarmModal.style.display = 'none';
                    if (navigator.vibrate) navigator.vibrate(0); 
                    showToast("Alarm Stopped", "‚è∞");
                };
            }
        });
    });
}, 60000);

function startLiveClock() {
    setInterval(() => {
        const ngayon = new Date();
        const timeString = ngayon.toLocaleTimeString('en-US', { 
            hour12: true, 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        const dateString = ngayon.toLocaleDateString('en-US', { 
            weekday: 'long', 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric' 
        });

        const clockEl = document.getElementById('live-clock');
        const dateEl = document.getElementById('live-date');
        
        if (clockEl) clockEl.innerText = timeString;
        if (dateEl) dateEl.innerText = dateString;
    }, 1000);
}

startLiveClock();

 function initSystem() {
   window.userRole = localStorage.getItem('appUserRole') || 'guest';
    onSnapshot(doc(db, "system-config", "global"), (snap) => {
        const data = snap.data();
        if (!data) return;
        const statusText = document.getElementById('global-status-text');
        const badge = document.getElementById('global-badge');
        const mScreen = document.getElementById('maint-screen');
        const tScreen = document.getElementById('term-screen');
        const mMsg = document.getElementById('m-msg');
        if(mScreen) mScreen.style.display = 'none';
        if(tScreen) tScreen.style.display = 'none';
        badge.className = "badge"; 

        if (data.state === 'terminated') {
            badge.classList.add('terminated');
            statusText.innerText = "";
            
            if (window.userRole !== 'admin') {
                if(tScreen) tScreen.style.display = 'flex';
            }
        } 
       else if (data.state === 'maintenance') {
    badge.classList.add('maintenance');
    statusText.innerText = "";
    
    if (window.userRole !== 'admin') {
        if(mScreen) {
            mScreen.style.display = 'flex';
            if(mMsg) mMsg.innerText = data.duration || "We‚Äôre currently performing scheduled maintenance to improve your experience.";
        }
    }
}
        else {
            badge.classList.add('online');
            statusText.innerText = "";
        }
    });
}
  window.handleLogin = async () => {
    const u = document.getElementById('log-u').value;
    const p = document.getElementById('log-p').value;
    const loginBtn = document.querySelector('#scr-login .btn');
    
    if (navigator.vibrate) navigator.vibrate(20);

    if(!u || !p) return showToast("Please enter credentials.", "üîë");

    const originalText = "Sign In"; 
    loginBtn.innerHTML = '<div class="spinner"></div>'; 
    loginBtn.disabled = true;
    loginBtn.classList.add('btn-loading'); 

    try {
        if(u === 'admin' && p === 'Admin022522') { 
            const remCheck = document.getElementById('log-remember');
            if(remCheck && remCheck.checked) {
                localStorage.setItem('rem_u', u);
                localStorage.setItem('rem_p', p);
            } else {
                localStorage.removeItem('rem_u');
                localStorage.removeItem('rem_p');
            }

            window.userRole = 'admin'; 
            localStorage.setItem('appUserRole', 'admin'); 
            
            showView('scr-admin'); 
            loadAdminData(); 
            return; 
        }

        const q = query(collection(db, "users"), where("username", "==", u), where("password", "==", p));
        const snap = await getDocs(q);
        
        if(!snap.empty) {
            const remCheck = document.getElementById('log-remember');
            if(remCheck && remCheck.checked) {
                localStorage.setItem('rem_u', u);
                localStorage.setItem('rem_p', p);
            } else {
                localStorage.removeItem('rem_u');
                localStorage.removeItem('rem_p');
            }

            const userDoc = snap.docs[0];
            const userData = userDoc.data();
            loggedInUserDoc = {
                uid: userDoc.id,
                ...userData
            }; 

            window.loggedInUserId = userDoc.id;
            
            localStorage.setItem('user_data', JSON.stringify(loggedInUserDoc));
            const savedPic = localStorage.getItem(`profile_pic_${userDoc.id}`);
            const savedBio = localStorage.getItem(`bio_${userDoc.id}`);
            window.updateProfileUI(savedPic);
            if(savedBio) document.getElementById('bioDisplay').innerText = `"${savedBio}"`;
           
            window.userRole = 'student';
            localStorage.setItem('appUserRole', 'student');

            if(userData.isActivated) {
                window.watchStudentProfile(userDoc.id); 
                showView('scr-student'); 
                
                const displayName = userData.senderName || userData.username || "Student";
                showToast(`Welcome Back, ${displayName}!`, "üéì");

                window.loadSubjects();
           
                const storageKey = `welcome_finished_${userDoc.id}`;
                if (localStorage.getItem(storageKey) !== 'true') { 
                    showWelcomeModal(userDoc.id, userData.senderName || "Student");
                }

            } else {
                showView('scr-activate'); 
            }
        } else {
            showToast("Invalid username or password.", "üö´");
        }
    } catch (err) {
        console.error(err);
        showToast("Connection Error.", "üåê");
    } finally {
        loginBtn.innerHTML = "Sign In"; 
        loginBtn.disabled = false;
        loginBtn.classList.remove('btn-loading');
    }
};


window.openAddSubjectModal = () => document.getElementById('subject-modal').style.display = 'flex';
window.closeSubModal = () => document.getElementById('subject-modal').style.display = 'none';
window.closeTaskModal = () => document.getElementById('task-modal').style.display = 'none';

window.saveSubject = async () => {
    const name = document.getElementById('sub-name').value.trim();
    const desc = document.getElementById('sub-desc').value.trim();
    
    if(!name) {
        if (navigator.vibrate) navigator.vibrate([50, 50]);
        return showToast("Add a Subject Name!", "‚ö†Ô∏è");
    }

    const studentIdClean = (typeof loggedInUserDoc === 'object') ? (loggedInUserDoc.uid || loggedInUserDoc.id) : loggedInUserDoc;

    try {
        await addDoc(collection(db, "subjects"), {
            studentId: studentIdClean, 
            name: name,
            desc: desc,
            createdAt: new Date().toISOString()
        });
        
        document.getElementById('sub-name').value = "";
        document.getElementById('sub-desc').value = "";
        document.getElementById('subject-modal').style.display = 'none';
        
        showToast("Subject saved successfully!", "üìö");
        console.log("Subject saved successfully with ID:", studentIdClean);

    } catch (e) { 
        console.error("Save Error:", e);
        showToast("Error saving: " + e.message, "‚ùå"); 
    }
};

   window.loadSubjects = () => {
    const grid = document.getElementById('subject-grid');
    
    const studentId = typeof loggedInUserDoc === 'object' ? loggedInUserDoc.uid : loggedInUserDoc;
    
    if (!studentId) return console.error("No student ID found for query");

    const q = query(collection(db, "subjects"), where("studentId", "==", studentId));
    
    onSnapshot(q, (snap) => {
        grid.innerHTML = "";
        snap.forEach(doc => {
            const s = doc.data();
            grid.innerHTML += `
                <div class="subject-card" onclick="window.openSubjectTasks('${doc.id}', '${s.name}')" 
                     style="background:#111; padding:20px; border-radius:15px; border:1px solid #222; cursor:pointer;">
                    <b style="color:var(--accent); font-size:18px;">${s.name}</b><br>
                    <small style="color:gray;">${s.desc || 'No schedule set'}</small>
                </div>`;
        });
    }, (error) => {
        console.error("Snapshot error:", error);
    });
};

    
    window.openSubjectTasks = (id, name) => {
        currentSubId = id;
        document.getElementById('modal-category-title').innerText = "üìö " + name;
        document.getElementById('task-modal').style.display = 'flex';
        window.loadTasks();
    };

    window.saveTask = async () => {
    const input = document.getElementById('new-task-input');
    if(!input.value.trim()) return;
    
    await addDoc(collection(db, "student_tasks"), {
        subjectId: currentSubId,
        taskName: input.value.trim()
    });
    
    input.value = ""; 
    
};

window.deleteTask = async (taskId) => {
    if(confirm("Mark as done?")) {
        await deleteDoc(doc(db, "student_tasks", taskId));
    }
};

let currentTaskIdToDelete = null;
let currentTaskStatusId = null;
let currentTaskNextStatus = "";
window.loadTasks = () => {
    const cont = document.getElementById('task-list-container');
    const q = query(collection(db, "student_tasks"), where("subjectId", "==", currentSubId));
    
    onSnapshot(q, (snap) => {
        cont.innerHTML = "";
        const ngayon = new Date().getTime();

        if (snap.empty) {
            cont.innerHTML = "<p style='color:gray; text-align:center; margin-top:20px;'>No tasks for this subject.</p>";
            return;
        }

        snap.forEach(d => {
            const t = d.data();
            const isDone = t.status === "completed";
            const deadlineTime = new Date(t.deadline).getTime();
            const isMissed = !isDone && deadlineTime < ngayon;

            cont.innerHTML += `
                <div style="background:#1a1a1a; padding:15px; border-radius:16px; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid ${isDone ? '#4cd964' : (isMissed ? '#ff4444' : '#ffbb33')}; margin-bottom:12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <div style="flex:1; opacity: ${isDone ? '0.5' : '1'}">
                        <span style="text-decoration: ${isDone ? 'line-through' : 'none'}; color: white; font-weight: bold; font-size: 1rem; display: block;">
                            ${t.taskName} ${isMissed ? '<span style="color:#ff4444; font-size:10px; background:rgba(255,68,68,0.1); padding:2px 6px; border-radius:4px; margin-left:5px;">‚ö†Ô∏è LATE</span>' : ''}
                        </span>
                        <small style="color: ${isMissed ? '#ff4444' : '#888'}; font-size:12px;">
                            üìÖ ${t.deadline.replace('T', ' ')}
                        </small>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="window.toggleTaskStatus('${d.id}', '${t.status || 'pending'}')" style="background:rgba(255,255,255,0.05); border:none; width:42px; height:42px; border-radius:12px; cursor:pointer; display:flex; justify-content:center; align-items:center; -webkit-tap-highlight-color:transparent;">
                            <span style="font-size:20px;">${isDone ? '‚Ü©Ô∏è' : '‚úÖ'}</span>
                        </button>
                        <button onclick="window.removeTask('${d.id}')" style="background:rgba(255,68,68,0.1); border:none; width:42px; height:42px; border-radius:12px; cursor:pointer; display:flex; justify-content:center; align-items:center; -webkit-tap-highlight-color:transparent;">
                            <span style="color:#ff4444; font-size:18px; font-weight:bold;">‚úï</span>
                        </button>
                    </div>
                </div>`;
        });
    });
};

window.removeTask = async (taskId) => {
    currentTaskIdToDelete = taskId;
    document.getElementById('task-delete-modal').style.display = 'flex';
    if (navigator.vibrate) navigator.vibrate(30);

    document.getElementById('confirm-task-del-btn').onclick = async () => {
        try {
            await deleteDoc(doc(db, "student_tasks", currentTaskIdToDelete));
            showToast("Task removed successfully", "üóëÔ∏è");
            if (navigator.vibrate) navigator.vibrate([40, 20]);
        } catch (e) {
            showToast("Error deleting task", "‚ùå");
        }
        closeTaskDeleteModal();
    };
};

window.closeTaskDeleteModal = () => {
    document.getElementById('task-delete-modal').style.display = 'none';
};

window.toggleTaskStatus = (id, currentStatus) => {
    if (currentStatus === "completed") {
        updateTaskStatusInFirebase(id, "pending");
    } else {
        currentTaskStatusId = id;
        currentTaskNextStatus = "completed";
        document.getElementById('task-done-modal').style.display = 'flex';
        if (navigator.vibrate) navigator.vibrate(30);
    }
};

document.getElementById('confirm-task-done-btn').onclick = async () => {
    await updateTaskStatusInFirebase(currentTaskStatusId, currentTaskNextStatus);
    closeTaskDoneModal();
};

async function updateTaskStatusInFirebase(id, newStatus) {
    try {
        await updateDoc(doc(db, "student_tasks", id), { status: newStatus });
        if (newStatus === "completed") {
            showToast("Mission Accomplished! üèÜ", "‚ú®");
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        } else {
            showToast("Moved to pending", "‚Ü©Ô∏è");
        }
    } catch (e) {
        showToast("Error: " + e.message, "‚ùå");
    }
}

window.closeTaskDoneModal = () => {
    document.getElementById('task-done-modal').style.display = 'none';
};

    window.genKey = async () => {
    const code = "SCH-" + Math.random().toString(36).substring(2, 8).toUpperCase();
    
    try {
        await addDoc(collection(db, "activation_codes"), { 
            code: code, 
            isUsed: false,
            createdAt: new Date().toISOString()
        });
        
        document.getElementById('key-card-container').style.display = 'block';
        document.getElementById('manual-code-text').innerText = code;
        
        const qrContainer = document.getElementById('qrcode-display');
        qrContainer.innerHTML = ""; 
        new QRCode(qrContainer, { 
            text: code, 
            width: 150, 
            height: 150,
            colorDark : "#000000",
            colorLight : "#ffffff"
        });
        if (navigator.vibrate) navigator.vibrate(50);
        showToast("New Key Generated: " + code, "üîë");
            } catch (e) {
        console.error("GenKey Error:", e);
        showToast("Error generating key: " + e.message, "‚ùå");
    }
};

  window.handleRegister = async () => {
    const n = document.getElementById('reg-n').value.trim();
    const u = document.getElementById('reg-u').value.trim();
    const ph = document.getElementById('reg-phone').value.trim();
    const lvl = document.getElementById('reg-level').value; 
    const e = document.getElementById('reg-e').value.trim();
    const p = document.getElementById('reg-p').value;
    const cp = document.getElementById('reg-cp').value;
    const agree = document.getElementById('reg-agree').checked;
    const addr = document.getElementById('reg-address').value.trim();
    const bday = document.getElementById('reg-birthdate').value;
    const gndrNode = document.querySelector('input[name="reg-gender"]:checked');
    const gndr = gndrNode ? gndrNode.value : "Not Specified";

    if(!n || !u || !ph || !lvl || !e || !p || !cp || !addr || !bday) {
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        return showToast("Please complete all required fields.", "‚ö†Ô∏è");
    }
    
    if(p !== cp) {
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        return showToast("Passwords do not match!", "‚ùå");
    }
    
    if(!agree) return showToast("Please agree to the Terms & Conditions.", "üìú");

    try {
        const uSnap = await getDocs(query(collection(db, "users"), where("username", "==", u)));
        

        if(!uSnap.empty) return showToast("Username already taken.", "üö´");

        await addDoc(collection(db, "users"), { 
            fullName: n, 
            username: u, 
            contactNumber: ph,
            personalContact: ph,
            level: lvl, 
            email: e, 
            password: p, 
            address: addr,
            birthdate: bday,
            gender: gndr,
            isActivated: false,
            dateRegistered: new Date().toISOString(),
            bio: "Welcome to my profile!",
            profilePic: null,
            schoolName: "",
            section: "",
            strandCourse: "",
            guardianName: "",
            emergencyNumber: "",
            guardianName2: "",
            emergencyNumber2: ""
        });

        if (navigator.vibrate) navigator.vibrate(100);
        showToast("Successfully Registered! Redirecting...", "üéâ"); 
        
        setTimeout(() => {
            showView('scr-login');
        }, 1500);
        
    } catch (err) {
        console.error(err);
        showToast("Error: " + err.message, "‚ùå");
    }
};

   window.verifyActivation = async () => {
    const keyInput = document.getElementById('act-key').value.toUpperCase().trim();
    const currentUser = loggedInUserDoc || JSON.parse(localStorage.getItem('user_data'));
    
    if (!keyInput) {
        if (navigator.vibrate) navigator.vibrate([50, 50]);
        return showToast("Please write or scan the activation key.", "‚ö†Ô∏è");
    }

    if (!currentUser || !currentUser.uid) {
        return showToast("Session error. Please log in again.", "‚ùó");
    }

    try {
        const q = query(
            collection(db, "activation_codes"), 
            where("code", "==", keyInput), 
            where("isUsed", "==", false)
        );
        const snap = await getDocs(q);

        if (!snap.empty) {
            const keyDoc = snap.docs[0];
            const keyDocId = keyDoc.id;
            
            await updateDoc(doc(db, "users", currentUser.uid), { 
                isActivated: true,
                activatedWith: keyInput,
                dateActivated: new Date().toISOString()
            });
            await updateDoc(doc(db, "activation_codes", keyDocId), { 
                isUsed: true,
                usedBy: currentUser.username
            });

            currentUser.isActivated = true;
            localStorage.setItem('user_data', JSON.stringify(currentUser));

            if (navigator.vibrate) navigator.vibrate(100);
            showToast("Account Activated! Welcome to Schedly Pro.", "üîì");

            showView('scr-student');
            window.watchStudentProfile(currentUser.uid);
            window.loadSubjects();
            
            const storageKey = `welcome_finished_${currentUser.uid}`;
            if (localStorage.getItem(storageKey) !== 'true') {
                setTimeout(() => {
                    showWelcomeModal(currentUser.uid, currentUser.senderName || "Student");
                }, 500);
            }

        } else { 
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            showToast("Wrong key or already used. Contact Admin.", "üö´"); 
        }
    } catch (err) { 
        console.error(err);
        showToast("Activation failed: " + err.message, "‚ùå"); 
    }
 };

    
window.startScanner = () => {
    document.getElementById('cam-btn').style.display = 'none';
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }
    
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    html5QrCode.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => { 
            try {
                document.getElementById('act-key').value = decodedText;
                
                await html5QrCode.stop();
                
                document.getElementById('reader').innerHTML = ""; 
                document.getElementById('cam-btn').style.display = 'block';
                
                if (navigator.vibrate) navigator.vibrate(50);
                showToast("QR Code Detected! Now click Activate.", "üì∏");

            } catch (stopErr) {
                console.warn("Stop error:", stopErr);
            }
        }
    ).catch((err) => {
        showToast("Camera Error: " + err, "‚ùå");
        document.getElementById('cam-btn').style.display = 'block';
    });
};

   window.loadAdminData = () => {
    onSnapshot(collection(db, "users"), (s) => {
        const list = document.getElementById('list-users-all'); 
        list.innerHTML = ""; 
        
        let activeCount = 0, pendingCount = 0;
        
        s.forEach(d => {
            const u = d.data();
            if(u.username === 'admin') return; 
            
            const isAct = u.isActivated;
            if(isAct) activeCount++; else pendingCount++;

            const statusLabel = isAct ? 
                `<span style="color:var(--success); font-size:10px; border:1px solid var(--success); padding:2px 8px; border-radius:10px;">ACTIVE</span>` : 
                `<span style="color:var(--maint); font-size:10px; border:1px solid var(--maint); padding:2px 8px; border-radius:10px;">PENDING</span>`;

            
            list.innerHTML += `
                <div class="item-row" style="flex-direction: column; align-items: flex-start; gap: 5px; padding: 15px; border-bottom: 1px solid #111;">
                    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                        <b style="font-size: 14px;">${u.fullName}</b>
                        ${statusLabel}
                    </div>
                    <div style="font-size: 11px; color: gray; line-height: 1.6;">
                        <span>üìç Level: ${u.level || 'N/A'}</span><br>
                        <span>üìû Contact: ${u.contactNumber || 'No Number'}</span><br>
                        <span>üë§ User: ${u.username}</span><br>
                        <span>üîí Password: *******</span><br>
                        <span style="color:var(--accent); font-weight:bold;">üîë Key: ${u.activatedWith || 'None'}</span>
                    </div>
                    
                    <div style="display: flex; gap: 8px; width: 100%; margin-top: 10px;">
                        <button onclick="openEditModal('${d.id}', '${u.fullName}', '${u.level || ''}', '${u.contactNumber || ''}')" 
                                style="flex: 1; background: var(--accent); border: none; color: #000; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: bold;">
                            EDIT INFO
                        </button>
                        
                        <button onclick="deleteUser('${d.id}')" 
                                style="flex: 1; background: none; border: 1px solid #333; color: var(--error); padding: 8px; border-radius: 8px; cursor: pointer; font-size: 10px;">
                            REMOVE
                        </button>
                    </div>
                </div>`;
        });
        
        document.getElementById('count-stud-active').innerText = activeCount;
        document.getElementById('count-stud-pending').innerText = pendingCount;
    });

    onSnapshot(collection(db, "activation_codes"), (s) => {
        const list = document.getElementById('list-keys-all'); 
        list.innerHTML = "";
        let uCount = 0, usedCount = 0;
        
        s.forEach(d => {
            const k = d.data();
            const isUsed = k.isUsed;
            if(isUsed) usedCount++; else uCount++;

            const keyLabel = isUsed ? 
                `<span style="color:#444; font-size:10px;">USED</span>` : 
                `<span style="color:var(--success); font-size:10px;">VALID</span>`;

            list.innerHTML += `
                <div class="item-row" style="display: flex; justify-content: space-between; padding: 10px 15px;">
                    <span style="font-family:monospace; font-weight:bold;">${k.code}</span>
                    ${keyLabel}
                </div>`;
        });
        document.getElementById('count-key-unused').innerText = uCount;
        document.getElementById('count-key-used').innerText = usedCount;
    });
};

   window.updateSys = async () => {
    const s = document.getElementById('sys-state').value;
    const t = document.getElementById('sys-time-end').value;
    const m = document.getElementById('sys-msg-in').value;

    try {
        await updateDoc(doc(db, "system-config", "global"), {
            state: s,
            endTime: t,
            duration: m 
        });       
        if (navigator.vibrate) navigator.vibrate(50);
        showToast("System Updated!", "‚öôÔ∏è");
        
    } catch (e) {
        console.error("System Update Error:", e);
        showToast("Update failed: " + e.message, "‚ùå");
    }
};

    window.postAnnouncement = async () => {
    const msg = document.getElementById('ann-msg-in').value;
    const rawExp = document.getElementById('ann-time-end').value;

    if(!msg || !rawExp) {
        if (navigator.vibrate) navigator.vibrate([50, 50]);
        return showToast("Please write the message and the expiry time!", "‚ö†Ô∏è");
    }

    const expiryISO = new Date(rawExp).toISOString();

    try {
        await addDoc(collection(db, "announcements"), {
            title: "Admin Update", 
            message: msg,
            expiryDate: expiryISO,
            createdAt: serverTimestamp()
        });
        
        if (navigator.vibrate) navigator.vibrate(100);
        showToast("Broadcast Sent! Students notified. üì¢", "‚ú®");

        document.getElementById('ann-msg-in').value = ""; 
        
    } catch (e) {
        console.error("Announcement Error:", e);
        showToast("Error: " + e.message, "‚ùå");
    }
};

    function showMaint(data) {
        document.getElementById('maint-screen').style.display = 'flex';
        document.getElementById('m-msg').innerText = data.duration;     
    }
    window.showView = (id) => { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); };
    window.admTab = (t, b) => { 
    document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('active')); 
    const target = document.getElementById('adm-' + t);
    if (target) target.classList.add('active'); 
    if (t === 'ann') {
        window.loadAdminAnnouncements(); 
    }
};
    window.checkStrength = (p) => {
        const b = document.getElementById('strength-bar');
        b.style.width = p.length*10 + "%";
        b.className = p.length < 5 ? "strength-bar weak" : p.length < 9 ? "strength-bar mid" : "strength-bar strong";
    };

   window.downloadKeyCard = () => {
    const area = document.getElementById('capture-area');
    const code = document.getElementById('manual-code-text').innerText;
    
    if (!code) {
        if (navigator.vibrate) navigator.vibrate(30);
        return showToast("Generate a key first!", "üîë");
    }
    showToast("Generating image, please wait...", "‚è≥");

    html2canvas(area, {
        backgroundColor: "#ffffff",
        scale: 2,
        useCORS: true
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Key-${code}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        
        showToast("Key Card downloaded! üíæ", "‚ú®");
        
    }).catch(err => {
        console.error("Download Error:", err);
        showToast("Cannot download. Take a screenshot instead.", "‚ùå");
    });
};

let userToDelete = null;
window.deleteUser = async (id) => {
    userToDelete = id;
    const modal = document.getElementById('delete-confirm-modal');
    modal.style.display = 'flex';
    
    document.getElementById('confirm-delete-btn').onclick = async () => {
        try {
            await deleteDoc(doc(db, "users", userToDelete));
            showToast("Student removed!", "üóëÔ∏è");
            closeDeleteModal();
            if (typeof loadAdminData === 'function') loadAdminData(); // Refresh list kung meron
        } catch (e) {
            console.error(e);
            showToast("Error deleting student.", "‚ùå");
        }
    };
};
window.closeDeleteModal = () => {
    document.getElementById('delete-confirm-modal').style.display = 'none';
    userToDelete = null;
};
window.setSystemState = async (newState) => {
    try {
        await updateDoc(doc(db, "system-config", "global"), { state: newState });
        showToast("System: " + newState.toUpperCase(), "üì°");
    } catch (e) {
        showToast("Error updating status: " + e.message, "‚ùå");
    }
};

    window.logoutSystem = () => {
   
    localStorage.removeItem('appUserRole');
    
    
    window.userRole = 'guest';

  
    location.reload(); 
};
   
window.watchStudentProfile = (docId) => {
    onSnapshot(doc(db, "users", docId), (snap) => {
        const userData = snap.data();
        if (!userData) return;
            
            
const dashName = document.getElementById('dash-user-name');
        const dashCircle = document.getElementById('user-initial');
        const badgeDiv = document.getElementById('global-badge');
        const badgeText = document.getElementById('global-status-text');

        if (dashName) {

            const isAdmin = userData.username === "hypens" || userData.role === "admin";

            if (isAdmin) {
                dashName.innerHTML = `${userData.fullName || userData.username} <span style="color:var(--accent); text-shadow: 0 0 10px rgba(212,175,55,0.8);">üíé</span>`;
                
                if (badgeText) badgeText.innerText = "SYSTEM ADMIN";
                if (badgeDiv) {
                    badgeDiv.style.background = "rgba(212,175,55,0.15)";
                    badgeDiv.style.borderColor = "var(--accent)";
                }
                if (dashCircle) {
                    dashCircle.style.border = "2.5px solid var(--accent)";
                    dashCircle.style.boxShadow = "0 0 15px rgba(212,175,55,0.5)";
                }
            } else {
                dashName.innerText = userData.fullName || userData.username || "Student";
                if (badgeText) badgeText.innerText = "Online";
                if (dashCircle) {
                    dashCircle.style.border = "none";
                    dashCircle.style.boxShadow = "none";
                }
            }
        }

if(dashCircle){

    if(userData.profilePic){

        dashCircle.innerHTML = `
        <img src="${userData.profilePic}"
        style="
            width:100%;
            height:100%;
            border-radius:50%;
            object-fit:cover;
        ">
        `;

    } else {

        const letter =
            (userData.fullName ||
             userData.username ||
             "S")
            .charAt(0)
            .toUpperCase();

        dashCircle.innerText = letter;
    }console.log("Profile Active: Triggering Counters...");
        window.startNavCounters(docId);  
}; 

        if(document.getElementById('st-name')) document.getElementById('st-name').innerText = userData.fullName.toUpperCase();
        if(document.getElementById('st-level')) document.getElementById('st-level').innerText = userData.level || "No Level Set";
        if(document.getElementById('st-user')) document.getElementById('st-user').innerText = "@" + userData.username;
        if(document.getElementById('st-phone')) document.getElementById('st-phone').innerText = userData.personalContact || userData.contactNumber || "No Number";
        const initialEl = document.getElementById('st-initials');
        const mainImg = document.getElementById('mainProfilePic');
        if (userData.profilePic && mainImg) {
            mainImg.src = userData.profilePic;
            mainImg.style.display = 'block';
            if(initialEl) initialEl.style.display = 'none';
        } else if (mainImg) {
            mainImg.style.display = 'none';
            if(initialEl) initialEl.style.display = 'flex';
            if(initialEl) initialEl.innerText = userData.fullName.charAt(0).toUpperCase();
        }
        const bioDisplay = document.getElementById('bioDisplay');
        if (bioDisplay) {
            bioDisplay.innerText = userData.bio || "Tap to add bio...";
        }
        if(document.getElementById('info-name')) document.getElementById('info-name').value = userData.fullName || "";
        if(document.getElementById('info-birthdate')) document.getElementById('info-birthdate').value = userData.birthdate || "";
        if(document.getElementById('info-personal-contact')) document.getElementById('info-personal-contact').value = userData.personalContact || "";
        if(document.getElementById('info-email')) document.getElementById('info-email').value = userData.email || "";
        if(document.getElementById('info-address')) document.getElementById('info-address').value = userData.address || "";
        if(document.getElementById('info-gender')) document.getElementById('info-gender').value = userData.gender || "Male";
        if(document.getElementById('info-school')) document.getElementById('info-school').value = userData.schoolName || "";
        if(document.getElementById('info-level')) document.getElementById('info-level').value = userData.level || "";
        if(document.getElementById('info-section')) document.getElementById('info-section').value = userData.section || "";
        if(document.getElementById('info-strand')) document.getElementById('info-strand').value = userData.strandCourse || "";
        if(document.getElementById('info-guardian-1')) document.getElementById('info-guardian-1').value = userData.guardianName || "";
        if(document.getElementById('info-emergency-1')) document.getElementById('info-emergency-1').value = userData.emergencyNumber || "";
        if(document.getElementById('info-guardian-2')) document.getElementById('info-guardian-2').value = userData.guardianName2 || "";
        if(document.getElementById('info-emergency-2')) document.getElementById('info-emergency-2').value = userData.emergencyNumber2 || "";
        const qrEl = document.getElementById('st-mini-qr');
        if(qrEl) qrEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${userData.username}`;
    });
};
      
    window.openEditModal = (id, name, level, phone) => {
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-name').value = name;
    document.getElementById('edit-level').value = level;
    document.getElementById('edit-phone').value = phone;
    document.getElementById('edit-modal').style.display = 'flex';
};

window.saveStudentEdit = async () => {
    const id = document.getElementById('edit-id').value;
    const newName = document.getElementById('edit-name').value.trim();
    const newLevel = document.getElementById('edit-level').value.trim();
    const newPhone = document.getElementById('edit-phone').value.trim();
    const newUsername = document.getElementById('edit-username').value.trim();
    const newPassword = document.getElementById('edit-password').value;
    if (!newUsername) {
        if (navigator.vibrate) navigator.vibrate([50, 50]);
        return showToast("Username is required.", "‚ö†Ô∏è");
    }

    try {
        const q = query(
            collection(db, "users"),
            where("username", "==", newUsername)
        );
        const snap = await getDocs(q);

        if (!snap.empty && snap.docs[0].id !== id) {
            return showToast("Username already taken.", "üö´");
        }

        const updates = {
            fullName: newName,
            level: newLevel,
            contactNumber: newPhone,
            username: newUsername
        };

        if (newPassword && newPassword.trim() !== "") {
            updates.password = newPassword;
        }

        await updateDoc(doc(db, "users", id), updates);

        document.getElementById('edit-modal').style.display = 'none';
        
        if (navigator.vibrate) navigator.vibrate(100);
        showToast("User updated successfully ‚úÖ", "‚ú®");
        
    } catch (err) {
        console.error(err);
        showToast("Error saving changes.", "‚ùå");
    }
};


let map; 
let marker;

window.openProfile = () => {
    document.getElementById('profile-modal').style.display = 'flex';
    setTimeout(() => {
        if (!map) {
            map = L.map('map-container').setView([14.4081, 120.9403], 15); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
        }
        
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                const { latitude, longitude } = position.coords;
                const latlng = [latitude, longitude];

                if (!marker) {
                    marker = L.marker(latlng).addTo(map).bindPopup("I'm here!").openPopup();
                } else {
                    marker.setLatLng(latlng);
                }
                map.setView(latlng, 16);
            }, (err) => {
                console.error("GPS Error:", err);
                
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                showToast("GPS Error: Check your location settings.", "üìç");
                
            }, { enableHighAccuracy: true });
        } else {
            showToast("Geolocation is not supported by this device.", "üö´");
        }
        map.invalidateSize();
    }, 300);
};

window.closeModal = (id) => {
    document.getElementById(id).style.display = 'none';
};

window.triggerLogout = () => {
    if (typeof playBtnSound === "function") playBtnSound();
    if (navigator.vibrate) navigator.vibrate(50); 

    const logoutModal = document.getElementById('logout-modal');
    if (logoutModal) {
        const content = logoutModal.querySelector('.modal-content');
        if(content) content.style.animation = 'none';
        
        logoutModal.style.display = 'flex';
        if(content) {
            content.offsetHeight; 
            content.style.animation = 'modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
        }
    }
};
window.confirmLogout = () => {
    if (typeof playActionSound === "function") playActionSound();
    
    localStorage.removeItem('appUserRole');
    location.reload();
};
window.closeLogoutModal = () => {
    if (typeof playBtnSound === "function") playBtnSound();
    
    const logoutModal = document.getElementById('logout-modal');
    if (logoutModal) {
        logoutModal.style.display = 'none';
    }
};
window.toggleActionMenu = () => {
    const menu = document.getElementById('actionMenu');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
};
window.handleImageUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
        
        if (file.size > 800000) return showToast("Choose a smaller photo (under 800kb).", "üñºÔ∏è");

        const reader = new FileReader();
        reader.onload = async (e) => {
            const imgUrl = e.target.result;
            
            const userId = loggedInUserDoc?.uid || loggedInUserDoc;

            try {
               
                await updateDoc(doc(db, "users", userId), {
                    profilePic: imgUrl
                });

                if (typeof loggedInUserDoc === 'object') {
                    loggedInUserDoc.profilePic = imgUrl;
                    localStorage.setItem('user_data', JSON.stringify(loggedInUserDoc));
                }

                if (window.updateProfileUI) window.updateProfileUI(imgUrl);  
                showToast("Profile Photo Updated!", "üì∏");
            } catch (err) {
                console.error(err);
                showToast("Error saving photo to cloud.", "‚ùå");
            }
        };
        reader.readAsDataURL(file);
    }
    if (window.toggleActionMenu) window.toggleActionMenu();
};

window.removeProfilePic = async () => {
    const userId = loggedInUserDoc?.uid || window.loggedInUserId;

    if(!userId) return showToast("User ID not found. Please re-login.", "‚ö†Ô∏è");

    try {
        await updateDoc(doc(db, "users", userId), {
            profilePic: null
        });

        if (typeof loggedInUserDoc === 'object') {
            loggedInUserDoc.profilePic = null;
            localStorage.setItem('user_data', JSON.stringify(loggedInUserDoc));
        }
        if (window.updateProfileUI) window.updateProfileUI(null);
        showToast("Profile photo removed.", "üóëÔ∏è");

    } catch (err) {
        console.error("Remove Photo Error:", err);
        showToast("Error removing photo.", "‚ùå");
    }
    
    if (window.toggleActionMenu) window.toggleActionMenu();
};

window.updateProfileUI = (url) => {
    const mainImg = document.getElementById('mainProfilePic');
    const stInit = document.getElementById('st-initials');
    if (url) {
        mainImg.src = url; mainImg.style.display = 'block';
        stInit.style.display = 'none';
    } else {
        mainImg.style.display = 'none';
        stInit.style.display = 'flex';
    }
};

window.openBioEditor = () => {
    const bioElement = document.getElementById('bioDisplay');
    const modal = document.getElementById('bio-modal');
    const input = document.getElementById('bio-input');

    if (!bioElement || !modal || !input) return;

    input.value = bioElement.innerText;
    
    modal.style.display = 'flex';
    if (navigator.vibrate) navigator.vibrate(30);
};

window.closeBioModal = () => {
    document.getElementById('bio-modal').style.display = 'none';
};

window.confirmBioUpdate = async () => {
    const newBio = document.getElementById('bio-input').value;
    const bioElement = document.getElementById('bioDisplay');
    
    const userId = (typeof loggedInUserDoc === 'object') ? 
                   (loggedInUserDoc.uid || loggedInUserDoc.id) : 
                   loggedInUserDoc;

    if (!userId) {
        showToast("Session Error: Please log in again.", "‚ö†Ô∏è");
        return;
    }

    try {
        const userRef = doc(db, "users", String(userId)); 
        
        await updateDoc(userRef, { bio: newBio });

        bioElement.innerText = newBio;
        window.closeBioModal(); 
        showToast("Bio updated successfully!", "‚ú®");
    } catch (e) {
        console.error("Firebase Update Error:", e);
        showToast("Failed to save bio.", "‚ùå");
    }
};

window.saveStudentInformation = async () => {
    if (!window.loggedInUserId) {
        showToast("Session expired. Please login again.", "‚ö†Ô∏è");
        return;
    }

    try {
        const dataToUpdate = {
            birthdate: document.getElementById('info-birthdate').value,
            gender: document.getElementById('info-gender').value,
            personalContact: document.getElementById('info-personal-contact').value,
            email: document.getElementById('info-email').value,
            address: document.getElementById('info-address').value,
            schoolName: document.getElementById('info-school').value,
            strandCourse: document.getElementById('info-strand').value,
            guardianName: document.getElementById('info-guardian-1').value,
            emergencyNumber: document.getElementById('info-emergency-1').value,
            guardianName2: document.getElementById('info-guardian-2').value,
            emergencyNumber2: document.getElementById('info-emergency-2').value,
            lastUpdated: new Date().toISOString()
        };

        await updateDoc(
            doc(db, "users", window.loggedInUserId),
            dataToUpdate
        );
        showToast("Information updated and synced!", "‚úÖ");
    } catch (err) {
        console.error("Save Error:", err);
        showToast("Error saving information.", "‚ùå");
    }
};




   window.handleTermsClick = (event) => {
    const checkbox = document.getElementById('reg-agree');
    const modal = document.getElementById('terms-modal');
    
    if (checkbox.checked) {
        checkbox.checked = false; 
        modal.style.display = 'flex';
        if (navigator.vibrate) navigator.vibrate(30);
    }
};

window.termsDecision = (agreed) => {
    const checkbox = document.getElementById('reg-agree');
    const modal = document.getElementById('terms-modal');
    
    if (agreed) {
        checkbox.checked = true;
        showToast("Terms Accepted! ‚úÖ");
    } else {
        checkbox.checked = false;
        showToast("Terms declined.", "‚ö†Ô∏è");
    }
    
    modal.style.display = 'none';
};

window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) {
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.remove(); 
                
                if (typeof window.showView === 'function') {
                    window.showView('scr-login');
                }
            }, 1000);
        }
    }, 5000); 
});

window.openTasks = () => {
    showView('scr-subjects');
    window.loadSubjects();
};

window.saveSubject = async () => {
    const name = document.getElementById('sub-name').value.trim();
    const desc = document.getElementById('sub-desc').value.trim();
    
    if(!name) return showToast("Add a name to the subject!", "‚ö†Ô∏è");

    const rawId = (typeof loggedInUserDoc === 'object') ? loggedInUserDoc.uid : loggedInUserDoc;
    const cleanId = String(rawId); 

    try {
        console.log("Attempting to save subject for ID:", cleanId);
        await addDoc(collection(db, "subjects"), {
            studentId: cleanId, 
            name: name,
            desc: desc,
            createdAt: new Date().toISOString()
        });
        
        document.getElementById('sub-name').value = "";
        document.getElementById('sub-desc').value = "";
        document.getElementById('subject-modal').style.display = 'none';
        
        showToast("Subject Saved!", "üìö");

    } catch (e) {
        console.error("Firebase Save Error:", e);
        showToast("Cant Saved: " + e.message, "‚ùå");
    }
};

window.loadSubjects = () => {
    const grid = document.getElementById('subject-grid');
    if(!grid) return;

    const studentIdClean = (typeof loggedInUserDoc === 'object') ? loggedInUserDoc.uid : loggedInUserDoc;

    const q = query(collection(db, "subjects"), where("studentId", "==", String(studentIdClean)));
    
    onSnapshot(q, (snap) => {
        grid.innerHTML = "";
        if(snap.empty) {
            grid.innerHTML = "<p style='color:gray; text-align:center; grid-column:1/-1;'>No subjects found.</p>";
            return;
        }
        snap.forEach(docSnap => {
            const s = docSnap.data();
            grid.innerHTML += `
                <div class="nav-card" onclick="window.openSubjectTasks('${docSnap.id}', '${s.name}')" 
                     style="position:relative; height:auto; padding:15px; border: 1px solid var(--accent); cursor:pointer; margin-bottom:10px;">
                    
                    <button onclick="event.stopPropagation(); window.deleteSubject('${docSnap.id}')" 
                            style="position:absolute; top:10px; right:10px; background:none; border:none; color:#ff4444; font-size:18px; cursor:pointer; z-index:10;">
                        ‚úï
                    </button>

                    <b style="color:var(--accent); font-size:16px;">${s.name}</b><br>
                    <small style="color:gray;">${s.desc || 'No schedule'}</small>
                </div>`;
        });
    });
};

window.deleteSubject = async (subjectId) => {
    try {
        await deleteDoc(doc(db, "subjects", subjectId));
        console.log("Subject deleted:", subjectId);
        showToast("Subject and its tasks deleted.", "üóëÔ∏è");
        
    } catch (e) {
        showToast("Error deleting subject: " + e.message, "‚ùå");
    }
};

window.openSubjectTasks = (id, name) => {
    currentSubId = id;
    document.getElementById('current-task-title').innerText = "üìö " + name.toUpperCase();
    showView('scr-tasks');
    window.loadTasks();
};
window.saveTask = async () => {
    const input = document.getElementById('new-task-input');
    const deadline = document.getElementById('task-deadline').value;
    
    if(!input.value.trim() || !deadline) {
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        return showToast("Please fill all the fields!", "üìù");
    }
    await addDoc(collection(db, "student_tasks"), {
        subjectId: currentSubId,
        taskName: input.value.trim(),
        deadline: deadline
    });

    input.value = "";
    if (navigator.vibrate) navigator.vibrate(50);
    showToast("Task saved! ‚úÖ");
};


window.openSchedules = () => {
    showView('scr-schedules-list'); 
    const content = document.getElementById('schedule-list-content');
    if(!content) return;
    content.innerHTML = "<p style='color:gray; text-align:center;'>Loading your classes...</p>";
    const studentIdClean = (typeof loggedInUserDoc === 'object') ? (loggedInUserDoc.uid || loggedInUserDoc.id) : loggedInUserDoc;
    const q = query(collection(db, "subjects"), where("studentId", "==", String(studentIdClean)));
    onSnapshot(q, (snap) => {
        content.innerHTML = "";
        
        if(snap.empty) {
            content.innerHTML = `
                <div style="text-align:center; padding:40px; color:gray;">
                    <p>No subjects found.</p>
                    <button onclick="openTasks()" style="color:var(--accent); background:none; border:1px solid var(--accent); padding:5px 15px; border-radius:5px;">Add Subject First</button>
                </div>`;
            return;
        }

        snap.forEach(docSnap => {
            const s = docSnap.data();
            content.innerHTML += `
                <div style="background: linear-gradient(135deg, #111, #1a1a1a); padding:15px; border-radius:15px; border-left:5px solid var(--accent); margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="color:var(--accent); font-size:17px; display:block;">${s.name}</b>
                        <span style="color:#bbb; font-size:13px;">üïí ${s.desc || 'No time set'}</span>
                    </div>
                    <button onclick="window.openSubjectTasks('${docSnap.id}', '${s.name}')" style="background:var(--accent); color:black; border:none; padding:7px 12px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:11px;">
                        GO TO TASKS
                    </button>
                </div>`;
        });
    });
};

window.openStudyMode = () => {
    window.resetTimer();
    showView('scr-study');
};



window.renderNotes = () => {
    const grid = document.getElementById('notes-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    notes.forEach(note => {
        const div = document.createElement('div');
        div.style = "background: #111; padding: 15px; border-radius: 15px; border-left: 4px solid var(--accent); cursor: pointer; transition: 0.3s;";
        div.onclick = () => openNoteEditor(note.id);
        div.innerHTML = `
            <div style="color: white; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${note.title || 'Untitled Note'}
            </div>
            <div style="color: #666; font-size: 11px;">${note.date}</div>
        `;
        grid.appendChild(div);
    });
};


window.createNewNote = () => {
    const newNote = {
        id: Date.now(),
        title: '',
        content: '',
        date: new Date().toLocaleDateString()
    };
    notes.unshift(newNote); 
    openNoteEditor(newNote.id);
};


window.openNoteEditor = (id) => {
    activeNoteId = id;
    const note = notes.find(n => n.id === id);
    
    
    document.getElementById('notes-list-container').style.display = 'none';
    document.getElementById('notes-editor-container').style.display = 'flex';
    document.getElementById('add-note-btn').style.display = 'none';
    
    document.getElementById('edit-note-title').value = note.title;
    document.getElementById('edit-note-body').innerHTML = note.content;
};


window.saveCurrentNote = () => {
    
    const noteIndex = notes.findIndex(n => n.id === activeNoteId);
    
    if (noteIndex !== -1) {
        notes[noteIndex].title = document.getElementById('edit-note-title').value;
        notes[noteIndex].content = document.getElementById('edit-note-body').innerHTML;
        
        
        localStorage.setItem('schedly_notes_list', JSON.stringify(notes));
        
        
        console.log("Saved note: " + notes[noteIndex].title);
    }
};


window.exitNotes = () => {
    const editor = document.getElementById('notes-editor-container');
    const list = document.getElementById('notes-list-container');
    const addBtn = document.getElementById('add-note-btn');

   
    if (editor.style.display === 'flex' || editor.style.display === 'block') {
        saveCurrentNote(); 
        editor.style.display = 'none';
        list.style.display = 'block';
        addBtn.style.display = 'block';
        renderNotes(); 
    } 
    
    else {
        showView('scr-student');
    }
};


window.formatNote = (cmd, val = null) => {
    document.execCommand(cmd, false, val);
    saveCurrentNote(); 
};


window.deleteCurrentNote = () => {
    const noteModal = document.getElementById('note-delete-modal');
    if (noteModal) {
        noteModal.style.display = 'flex';
        
        document.getElementById('confirm-note-delete').onclick = () => {
            notes = notes.filter(n => n.id !== activeNoteId);
            localStorage.setItem('schedly_notes_list', JSON.stringify(notes));
            
            if (window.showToast) showToast("Note deleted! üóëÔ∏è");
            if (navigator.vibrate) navigator.vibrate([40, 30]);
            noteModal.style.display = 'none';
            exitNotes();
        };
    }
};

window.addEventListener('load', renderNotes);
window.addEventListener('load', window.loadNotes);


window.openPeerBoard = () => {
    showView('scr-peer');
    renderPosts(); 
};
window.renderPosts = () => {
    const container = document.getElementById('peer-posts-container');
    if (!container) return;
    
    const badge = document.getElementById('peerBadge');

    if (container.offsetParent !== null) {
        unreadCount = 0;
        if (badge) {
            badge.innerText = "";
            badge.style.display = "none";
        }
    }

    const q = query(collection(db, "peer_posts"), orderBy("createdAt", "desc"));
    
    onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const data = change.doc.data();
                const postId = change.doc.id;
                const rawUserData = localStorage.getItem('user_data');
                const currentUser = rawUserData ? JSON.parse(rawUserData) : null;
                
                const postTime = data.createdAt?.toMillis ? data.createdAt.toMillis() : (data.createdAt || Date.now());

                if (postTime > lastPostTime && currentUser && String(data.senderId) !== String(currentUser.uid) && !notifiedPostIds.has(postId)) {
                    
                    notifiedPostIds.add(postId);
                    const sound = document.getElementById('notif-sound');
                    if (sound) { sound.currentTime = 0; sound.play().catch(e => {}); }
                    
                    if (typeof showEmergencyBanner === "function") {
                        showEmergencyBanner(data.senderName, data.text);
                    }
                    if (container.offsetParent === null) {
                        unreadCount++;
                        if (badge) {
                            badge.innerText = "+" + unreadCount;
                            badge.style.display = "block";
                        }
                    } else {
                        unreadCount = 0;
                        if (badge) {
                            badge.innerText = "";
                            badge.style.display = "none";
                        }
                    }
                }
            }
        });

        if (!snapshot.empty && snapshot.docs[0].data().createdAt) {
            const latest = snapshot.docs[0].data().createdAt;
            lastPostTime = latest.toMillis ? latest.toMillis() : latest;
        }

        container.innerHTML = "";
        const rawUserData = localStorage.getItem('user_data');
        const currentUser = rawUserData ? JSON.parse(rawUserData) : null;
        const isViewerAdmin = currentUser && (currentUser.username === "hypens" || currentUser.username === "C");

        snapshot.forEach((doc) => {
            const data = doc.data();
            const postId = doc.id;
            const isBanished = data.isBanished === true;
            const isMuted = data.isMuted === true; 
            const censoredText = isMuted ? "****************" : (data.text || "");
            const mutedBadge = isMuted ? `<span style="font-size: 8px; color: #ff4757; background: rgba(255, 71, 87, 0.1); padding: 1px 5px; border-radius: 4px; border: 1px solid rgba(255, 71, 87, 0.2); margin-left: 5px; vertical-align: middle; font-weight: 900;">MUTED üîá</span>` : "";

            if (isBanished) {
                const snapSound = new Audio('./snap.mp3');
                snapSound.volume = 0.4;
                snapSound.play().catch(e => {});
            }

            const isAdminPost = data.role === "admin" || data.isAdmin === true;
            const isOwner = currentUser && (String(data.senderId) === String(currentUser.uid));
            const canDelete = isOwner || isViewerAdmin;
            const counterId = `count-${postId}`;
            
            onSnapshot(collection(db, "peer_posts", postId, "comments"), (cSnap) => {
                const el = document.getElementById(counterId);
                if (el) el.innerText = cSnap.size;
            });

            const postHTML = `
    <div id="post-card-${postId}" class="post-card ${isAdminPost ? 'admin-luxury-card' : ''} ${isBanished ? 'banished-post' : ''}" style="
        flex-shrink: 0; width: 100%; box-sizing: border-box; 
        background: ${isAdminPost ? 'linear-gradient(145deg, rgba(184, 134, 11, 0.2), rgba(10, 10, 10, 0.95))' : 'rgba(255,255,255,0.03)'} !important;
        padding: 16px; border-radius: 18px; margin-bottom: 15px; 
        border: ${isAdminPost ? '1px solid rgba(255, 215, 0, 0.4)' : '1px solid rgba(255,255,255,0.08)'} !important;
        box-shadow: ${isAdminPost ? '0 0 15px rgba(184, 134, 11, 0.3)' : 'none'} !important;
        position: relative;
    ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 42px; height: 42px; border-radius: 50%; padding: 1.5px; 
                    background: ${isAdminPost ? 'linear-gradient(45deg, #B8860B, #FFD700)' : 'rgba(255,255,255,0.1)'};">
                    <div style="width: 100%; height: 100%; border-radius: 50%; overflow: hidden; background: #000;">
                        <img src="${data.senderImg && data.senderImg !== 'null' ? data.senderImg : 'https://ui-avatars.com/api/?name=' + data.senderName}" 
                             onclick="window.viewPeerProfile('${data.senderId}')"
                             style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;">
                    </div>
                </div>
                <div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <strong style="font-size: 14px; color: ${isAdminPost ? '#FFD700' : '#fff'}; font-weight: 800; text-shadow: 0 0 8px rgba(255, 215, 0, 0.3);">
                            ${data.senderName}${mutedBadge} 
                        </strong>
                        ${isAdminPost ? `<span style="font-size: 14px; animation: goldShine 2s infinite ease-in-out; display: inline-block;">‚ú¶</span>` : ''}
                    </div>
                    ${isAdminPost ? `<span style="font-size: 10px; color: #B8860B; font-weight: 900; letter-spacing: 2px; display: block; margin-top: -2px;">DEV</span>` 
                    : `<span style="font-size: 10px; color: #555; display: block;">${data.timeDisplay || 'Just now'}</span>`}
                </div>
            </div>
            ${canDelete ? `<button onclick="window.deletePost('${postId}')" style="background:transparent; border:none; color:${isAdminPost ? '#B8860B' : 'rgba(255,255,255,0.2)'}; font-size: 20px; cursor:pointer;">&times;</button>` : ''}
        </div>
        <p style="margin: 0; font-size: 14px; color: ${isMuted ? 'rgba(255,255,255,0.2)' : '#eee'}; line-height: 1.5; word-wrap: break-word;">
            ${censoredText}
        </p>
        ${data.image ? `
            <div style="margin-top: 10px; display: flex; justify-content: flex-start;">
                <div style="max-width: 85%; max-height: 250px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); background: #000;">
                    <img src="${data.image}" style="display: block; max-width: 100%; max-height: 250px; object-fit: contain; cursor: pointer;" onclick="window.viewFullImage('${data.image}')">
                </div>
            </div>` : ''}
        <div style="display: flex; gap: 20px; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div onclick="window.reactToPost('${postId}')" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <span>‚ù§Ô∏è</span> <span style="font-size: 12px; color: ${isAdminPost ? '#FFD700' : '#888'}; font-weight: bold;">${data.likes || 0}</span>
            </div>
            <div onclick="window.openCommentModal('${postId}')" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <span>üí¨</span> <span id="${counterId}" style="font-size: 12px; color: #B8860B; font-weight: 900; background: rgba(184, 134, 11, 0.15); padding: 1px 6px; border-radius: 6px;">0</span>
            </div>
        </div>
    </div>`;
            container.insertAdjacentHTML('beforeend', postHTML);
        });

        if (snapshot.empty) {
            container.innerHTML = '<p style="text-align:center; color:#666; font-size:12px; margin-top:20px;">No posts yet.</p>';
        }
    });
};

window.addPost = async () => {
    const input = document.getElementById('peer-input');
    const user = JSON.parse(localStorage.getItem('user_data'));
    if (!user) return showToast("Login first! ‚ùå");

    let imageUrl = null;
    if (window.selectedImgFile) {
        showToast("Uploading... üì∏");
        imageUrl = await uploadToCloudinary(window.selectedImgFile);
    }
    if (!input.value.trim() && !imageUrl) return;

    try {
        await addDoc(collection(db, "peer_posts"), {
            text: input.value,
            image: imageUrl,
            senderName: user.username,
            senderImg: user.profilePic || "null",
            senderId: user.uid,
            role: (user.username === "hypens" || user.username === "C") ? "admin" : "student",
            isAdmin: (user.username === "hypens" || user.username === "C"),
            timeDisplay: new Date().toLocaleString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' }),
            createdAt: serverTimestamp()
        });
        input.value = "";
        if (window.removeImg) window.removeImg();
        showToast("Post shared! üöÄ");
    } catch (e) {
        console.error(e);
        showToast("Post failed ‚ùå");
    }
};

window.deletePost = async (id) => {
    const rawData = localStorage.getItem('user_data');
    const user = rawData ? JSON.parse(rawData) : null;
    const isActuallyAdmin = user && (user.username === "hypens" || user.username === "C");

    if (isActuallyAdmin) {
        const snapSound = new Audio('./snap.mp3');
        snapSound.play().catch(e => {});

        try {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        await updateDoc(doc(db, "peer_posts", id), { isBanished: true });
            setTimeout(async () => {
                const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await deleteDoc(doc(db, "peer_posts", id));
            }, 2000);

        } catch (e) { console.error("Banish error:", e); }
    } else {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        await deleteDoc(doc(db, "peer_posts", id));
    }
};

window.openShortcuts = () => {
    showView('scr-shortcuts');
};

window.openAbout = () => {
    showView('scr-about');
};

window.openStudyMode = () => {
    showView('scr-study'); 
};

window.showView = (id) => {
    document.querySelectorAll('.view').forEach(v => {
        v.style.display = 'none';
        v.classList.remove('active');
    });

    const target = document.getElementById(id);
    
    if (target) {
        target.style.display = 'flex'; 
        target.classList.add('active');
        console.log("Screen " + id + " is now visible.");
    } else {
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]); 
        showToast("System Error: Screen " + id + " not found! ‚ùå");
    }
};

window.toggleTimer = () => {
    const btn = document.getElementById('timer-btn');
    const display = document.getElementById('timer-display');
    const inputWrapper = document.getElementById('timer-input-wrapper');
    const status = document.getElementById('timer-status');

    if (!timerInterval) {
        let mins = document.getElementById('custom-min').value;
        if (timeLeft <= 0) {
            timeLeft = parseInt(mins) * 60;
        }

        if (isNaN(timeLeft) || timeLeft <= 0) {
            if (navigator.vibrate) navigator.vibrate([50, 50]);
            showToast("Please enter a valid number of minutes.", "‚ö†Ô∏è");
            return;
        }

        if(inputWrapper) inputWrapper.style.display = 'none';
        if(display) display.style.display = 'block';
        status.innerText = "Focus Session Active";
        status.style.color = "var(--success)";

        timerInterval = setInterval(() => {
            timeLeft--;
            window.updateTimerDisplay();

            if (timeLeft === 10) {
                status.innerText = "‚ö†Ô∏è ALMOST DONE!";
                status.style.color = "var(--error)";
                playRingingSound(); 
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                
                status.innerText = "üö® RINGGGGG! TIME'S UP!";
                status.style.color = "var(--error)";
                
                playRingingSound(); 
                
                setTimeout(() => {
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    showToast("üö® TIME'S UP! Reset to stopped.", "‚è∞");
                    
                    playRingingSound(true);
                    window.resetTimer();    
                }, 100);
            }
        }, 1000);

        btn.innerText = "PAUSE";
        btn.style.background = "var(--error)";

    } else {
        clearInterval(timerInterval);
        timerInterval = null;
        playRingingSound(true); 
        btn.innerText = "RESUME";
        btn.style.background = "var(--success)";
        status.innerText = "Session Paused";
        status.style.color = "#666";
    }
};
window.resetTimer = () => {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    timeLeft = 0;
    playRingingSound(true); 
    document.getElementById('timer-input-wrapper').style.display = 'block';
    document.getElementById('timer-display').style.display = 'none';
    document.getElementById('timer-status').innerText = "Set your study goal";
    document.getElementById('timer-status').style.color = "#666";

    const btn = document.getElementById('timer-btn');
    btn.innerText = "START";
    btn.style.background = "var(--success)";
};

window.updateTimerDisplay = () => {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
};

window.loadAdminAnnouncements = () => {
    const container = document.getElementById('admin-ann-list');
    if (!container) return;
    const q = query(collection(db, "announcements"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
        container.innerHTML = "";
        if(snap.empty) {
            container.innerHTML = "<p style='color:gray; font-size:12px;'>No records found.</p>";
            return;
        }    
        snap.forEach(docSnap => {
            const a = docSnap.data();
            container.innerHTML += `
                <div style="background:#111; padding:12px; margin-top:10px; border-radius:8px; border:1px solid #222;">
                    <p style="color:white; margin:0; font-size:14px;">${a.message}</p>
                    <small style="color:var(--accent); font-size:10px;">Expiry: ${new Date(a.expiryDate).toLocaleString()}</small>
                    <button onclick="window.deleteAnnouncement('${docSnap.id}')" style="float:right; background:none; border:none; color:red; cursor:pointer; font-weight:bold;">‚úï</button>
                </div>`;
        });
    });
};

window.deleteAnnouncement = async (id) => {
    try {
        await deleteDoc(doc(db, "announcements", id));
        
        if (window.showToast) {
            showToast("Announcement removed", "üóëÔ∏è");
        }
        if (navigator.vibrate) navigator.vibrate([40, 20]);
        
    } catch (e) {
        console.error("Delete Error:", e);
        if (window.showToast) showToast("Error deleting announcement", "‚ùå");
    }
};

function startSplashAnimation() {
    const container = document.getElementById('falling-items-bg');
    const splashSound = document.getElementById('splash-sound');
    const items = ['üìö', '‚úèÔ∏è', 'üìì', '‚è∞', 'üìñ', 'üñãÔ∏è', 'üé®', 'üìè', 'üìé', 'üíª', 'üéí', 'üß™', 'üìê'];
    
    let splashPlayPromise;

    if (splashSound) {
        splashSound.volume = 0.4;
        splashPlayPromise = splashSound.play();
    }

    const creator = setInterval(() => {
        const splash = document.getElementById('splash-screen');       
        if (!splash || splash.style.display === 'none' || getComputedStyle(splash).opacity === '0') {
            
            if (splashSound && splashPlayPromise !== undefined) {
                splashPlayPromise.then(() => {
                    let fadeOut = setInterval(() => {
                        if (splashSound.volume > 0.05) {
                            splashSound.volume -= 0.05;
                        } else {
                            splashSound.pause();
                            splashSound.currentTime = 0; 
                            clearInterval(fadeOut);
                        }
                    }, 100);
                }).catch(e => console.log("Splash sound intro interrupted."));
            }
            
            clearInterval(creator);
            return;
        }
        const div = document.createElement('div');
        div.className = 'falling-item';
        div.innerText = items[Math.floor(Math.random() * items.length)];
        div.style.left = Math.random() * 100 + '%';
        div.style.animationDuration = (3 + Math.random() * 3) + 's';
        div.style.fontSize = (15 + Math.random() * 25) + 'px';
        container.appendChild(div);
        setTimeout(() => div.remove(), 6000);
    }, 100); 
}

startSplashAnimation();

window.listenToAnnouncements = () => {
    const list = document.getElementById('notif-list-container');
    const badge = document.getElementById('notif-count');
    const banner = document.getElementById('global-announcement-banner');
    const bannerText = document.getElementById('banner-text');
    const notifSound = document.getElementById('notif-sound');
    let lastSeenId = localStorage.getItem('last_notif_id');
    
    const cached = localStorage.getItem('cached_announcements');
    if (cached && list) {
        list.innerHTML = cached; 
    }
    const q = query(collection(db, "announcements"), orderBy("expiryDate", "desc"));

    onSnapshot(q, (snap) => {
        let activeCount = 0;
        const now = new Date().getTime();
        let htmlCollector = ""; 

        snap.docChanges().forEach(change => {
            if (change.type === "added") {
                const a = change.doc.data();
                const expiryTime = new Date(a.expiryDate).getTime();

                if (expiryTime > now && change.doc.id !== lastSeenId) {
                    if(banner && bannerText) {
                        bannerText.innerText = `üì¢ NEW ANNOUNCEMENT!`; 
                        banner.style.display = 'block';  
                       
                        banner.onclick = () => {
                            banner.style.display = 'none';
                            window.openNotifications(); 
                        };

                        if (notifSound) {
                            notifSound.currentTime = 0;
                            notifSound.volume = 0.3; 
                            notifSound.play().catch(e => console.log("Audio play deferred."));
                        }

                        setTimeout(() => { banner.style.display = 'none'; }, 10000); 
                        
                        localStorage.setItem('last_notif_id', change.doc.id);
                        lastSeenId = change.doc.id;
                    }
                }
            }
        });

        if(list) list.innerHTML = "";

        snap.forEach(docSnap => {
            const a = docSnap.data();
            const expiryTime = new Date(a.expiryDate).getTime();
            if (expiryTime > now) {
                activeCount++; 
                const cardHtml = `
                    <div style="background:#111; padding:15px; border-radius:12px; margin-bottom:12px; border-left:4px solid var(--accent); border-top: 1px solid #222;">
                        <b style="color:var(--accent); font-size:14px; display:block; margin-bottom:5px;">üì¢ ${a.title}</b>
                        <p style="color:#eee; font-size:13px; margin:0; line-height:1.5; word-wrap: break-word; white-space: pre-wrap;">${a.message}</p>
                        <small style="color:#444; font-size:9px; display:block; margin-top:8px;">Active until: ${a.expiryDate}</small>
                    </div>`;
                
                if(list) list.innerHTML += cardHtml;
                htmlCollector += cardHtml; 
            }
        });

        localStorage.setItem('cached_announcements', htmlCollector);

        if(badge) {
            badge.innerText = activeCount;
            badge.style.display = activeCount > 0 ? "flex" : "none";
        }
    });
};

window.listenToAnnouncements();

window.openNotifications = () => {
    const overlay = document.getElementById('notif-overlay');
    if(overlay) overlay.style.display = 'block';
};

window.openSupport = () => {
    const modal = document.getElementById('support-modal');
    if (modal) {
        modal.style.display = 'flex';
        if (navigator.vibrate) navigator.vibrate(30); 
    }
};

window.closeSupportModal = () => {
    const modal = document.getElementById('support-modal');
    if (modal) modal.style.display = 'none';
};
    
document.addEventListener('DOMContentLoaded', () => {
    const sU = localStorage.getItem('rem_u');
    const sP = localStorage.getItem('rem_p');
    const uField = document.getElementById('log-u');
    const pField = document.getElementById('log-p');
    const rCheck = document.getElementById('log-remember');
     
    if (uField && pField && rCheck) {
        if (sU && sP) {
            uField.value = sU;
            pField.value = sP;
            rCheck.checked = true;
        }
    }
    if (typeof startSplashAnimation === "function") {
        startSplashAnimation();
    }
    const music = document.getElementById('bg-music');
    if (music) { music.load(); }
    const startMusic = () => {
        if (music && music.paused) {
            window.toggleMusic(); 
            document.removeEventListener('click', startMusic);
            document.removeEventListener('touchstart', startMusic);
        }
    };

    setTimeout(startMusic, 1000);

    document.addEventListener('click', startMusic);
    document.addEventListener('touchstart', startMusic);

    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        const login = document.getElementById('scr-login'); 

        if (splash) {
            splash.style.transition = "opacity 1s ease";
            splash.style.opacity = '0';
            
            setTimeout(() => {
                splash.style.display = 'none';

                if (login) {
                    login.style.display = 'block'; 
                    console.log("Splash finished, Login shown.");
                } else {
                
                    showView('scr-login');
                }
            }, 1500);
        }
    }, 10000); 
});
    
let musicFadeInterval; 

window.toggleMusic = function() {
    const music = document.getElementById('bg-music');
    const icon = document.getElementById('music-icon');
    const touchBtn = document.getElementById('music-touch');

    clearInterval(musicFadeInterval);

    if (music.paused) {
        music.play().catch(e => console.log("Blocked: ", e));
        icon.innerText = "üéµ";
        touchBtn.classList.add('music-playing');
        musicFadeInterval = setInterval(() => {
            if (music.volume < 0.35) { 
                music.volume = Math.min(0.35, music.volume + 0.05);
            } else {
                clearInterval(musicFadeInterval);
            }
        }, 200);
    } else {
        icon.innerText = "üîá";
        touchBtn.classList.remove('music-playing');
        musicFadeInterval = setInterval(() => {
            if (music.volume > 0.05) {
                music.volume = Math.max(0, music.volume - 0.05);
            } else {
                music.pause();
                clearInterval(musicFadeInterval);
            }
        }, 100);
    }
};

document.addEventListener('touchstart', function (event) {
    if (event.touches.length > 1) {
        event.preventDefault(); 
    }
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    let now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault(); 
    }
    lastTouchEnd = now;
}, false);

const showWelcomeModal = (userId, userName) => {
    const modal = document.getElementById('welcome-modal');
    const stepContent = document.getElementById('modal-step-content');
    const nextBtn = document.getElementById('modal-next-btn');
    const storageKey = `welcome_finished_${userId}`;
    
    if (localStorage.getItem(storageKey) === 'true') return;

    let currentStep = 0;
    const steps = [
        {
            title: `Welcome to Schedly, ${userName}!`,
            message: "Your ultimate academic companion. Schedly is designed to help students organize tasks, track schedules, and collaborate with peers seamlessly. Let's make your student life more productive and stress-free!"
        },
        {
            title: "üë§ Profile & Identity",
            message: "Personalize your experience! Set up your profile picture, write a bio that represents you, and even track your current location for security and academic reference."
        },
        {
            title: "üìã Task Management",
            message: "Never miss a deadline again. Organize your academic responsibilities, set priorities, and get real-time alerts when a task is due."
        },
        {
            title: "üìÖ Smart Schedules",
            message: "Keep track of your classes and school events. View your daily routine in a clean, organized layout so you're always prepared for what's next."
        },
        {
            title: "üß† Study Mode",
            message: "Boost your focus! Use the Study Mode to minimize distractions and manage your study sessions effectively using optimized focus timers."
        },
        {
            title: "üìù My Notes",
            message: "Capture ideas instantly. Our built-in notepad allows you to store important lecture points, reminders, and quick thoughts directly within the app."
        },
        {
            title: "ü§ù Peer Board",
            message: "Connect with your classmates. Share updates, ask questions, and collaborate with your peers through the real-time community feed."
        },
        {
            title: "‚ö° Quick Shortcuts",
            message: "Efficiency at its best. Access the most used features of the app with a single tap using our strategically placed navigation shortcuts."
        },
        {
            title: "‚ÑπÔ∏è About Schedly",
            message: "Schedly is a dedicated platform built for students, by students. Our mission is to bridge the gap between complex academic requirements and effective time management."
        },
        {
            title: "üõ†Ô∏è Meet the Developers",
            message: `
                <div style="text-align:left; font-size:12px; max-height:200px; overflow-y:auto; padding-right:10px;">
                    <b style="color:var(--accent)">Stephen John O. Jaynos</b> - Lead Developer / UI Designer<br>
                    <b>John Joshua Sumilang</b> - Developer<br>
                    <b>Alexandra Villasis</b> - Developer<br>
                    <b>Arby Castillo</b> - Developer<br>
                    <b>Arvie Arsenia</b> - Developer<br>
                    <b>Christian A. Sibolino</b> - Developer<br>
                    <b>Cyruz Amaro</b> - Developer<br>
                    <b>Farhan Paningbatan</b> - Developer
                </div>
            `
        },
        {
            title: "üìû Get in Touch",
            message: `
                <div style="font-size:14px; line-height:1.8;">
                    üåê FB Page: <b>SCHEDLY</b><br>
                    üìß Email: <b>YourSchedly@gmail.com</b><br>
                    üìû Phone: <b>+639928072368</b><br>
                    üöÄ Website: <i>Coming Soon</i>
                </div>
            `
        }
    ];
    const updateModal = () => {
    const s = steps[currentStep];
    stepContent.classList.remove('modal-text-animate');
    void stepContent.offsetWidth; 
    stepContent.classList.add('modal-text-animate');
    stepContent.innerHTML = `
        <h2 style="
            color: var(--accent); 
            margin: 0 0 15px 0; 
            font-size: 20px; 
            line-height: 1.2; 
            display: block; 
            width: 100%;
            word-wrap: break-word;">
            ${s.title}
        </h2>
        <div style="
            color: #ccc; 
            font-size: 14px; 
            line-height: 1.5; 
            text-align: center; 
            display: block; 
            width: 100%;
            max-height: 250px; 
            overflow-y: auto; 
            padding: 0 5px;">
            ${s.message}
        </div>
    `;
    nextBtn.innerText = (currentStep === steps.length - 1) ? "START PRODUCTIVITY" : "NEXT";
};

    modal.style.display = 'flex';
    updateModal();

    nextBtn.onclick = () => {
        if (typeof playNextSound === "function") {
            playNextSound();
        } else {
            const clickSfx = document.getElementById('next-sound');
            if (clickSfx) {
                clickSfx.currentTime = 0; 
                clickSfx.play().catch(e => console.log("Audio play deferred"));
            }
        }
        if (currentStep < steps.length - 1) {
            currentStep++;
            updateModal();
            stepContent.scrollTop = 0; 
        } else {
            localStorage.setItem(storageKey, 'true');
            modal.style.display = 'none';
        }
    };
};

window.playActionSound = () => {
    const sfx = document.getElementById('action-sound');
    if (sfx) {
        sfx.volume = 0.3; 
        sfx.currentTime = 0;
        sfx.play().catch(e => {});
    }
};

window.playNextSound = () => {
    const sfx = document.getElementById('next-sound');
    if (sfx) {
        sfx.volume = 0.3; 
        sfx.currentTime = 0;
        sfx.play().catch(e => console.log("Sound blocked"));
    }
};

window.playBtnSound = () => {
    const sfx = document.getElementById('btn-sound');
    if (sfx) {
        sfx.volume = 0.3; 
        sfx.currentTime = 0;
        sfx.play().catch(e => console.log("Sound blocked"));
    }
};

document.addEventListener('click', (e) => {
    const target = e.target.closest('.nav-card, .task-item, button, .btn, [onclick]');
    
    if (!target) return; 

    const isModalNext = target.id === 'modal-next-btn';
    if (isModalNext) return;

    if (target.classList.contains('nav-card') || target.classList.contains('task-item')) {
        playActionSound(); 
    } 
    else {
        playBtnSound();
    }
});

window.showToast = function(message, icon = "üëã") {
    const toast = document.getElementById('toast-container');
    const msgSpan = document.getElementById('toast-message');
    const iconSpan = document.getElementById('toast-icon');

    if (!toast) return;

    msgSpan.innerText = message;
    iconSpan.innerText = icon;

    msgSpan.style.whiteSpace = "nowrap";
    msgSpan.style.overflow = "hidden";
    msgSpan.style.textOverflow = "ellipsis";
    msgSpan.style.display = "block";
    
    iconSpan.style.flexShrink = "0";

    toast.style.opacity = "1";
    toast.style.transform = "translateX(-50%) translateY(0)";

    if (toast.timeoutId) clearTimeout(toast.timeoutId);

    toast.timeoutId = setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(-50%) translateY(100px)";
    }, 3000);
};

window.openGradeCalc = function() {
    console.log("Grade Calc Opening..."); 
    
    if (typeof showView === 'function') {
        showView('scr-grade-calc');
    } else {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.getElementById('scr-grade-calc').style.display = 'flex';
    }
    const container = document.getElementById('grade-inputs-container');
    if (container && container.innerHTML.trim() === "") {
        for (let i = 0; i < 4; i++) {
            addSubjectRow();
        }
    }
};

window.addSubjectRow = function() {
    const container = document.getElementById('grade-inputs-container');
    if (!container) return;
    
    const row = document.createElement('div');
    row.style = "display: flex; gap: 10px; margin-bottom: 10px; align-items: center; width: 100%; box-sizing: border-box;";
    row.innerHTML = `
        <input type="text" placeholder="Subject" style="flex: 2; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; font-size: 14px; outline: none; min-width: 0;">
        <input type="number" class="grade-input" placeholder="0.0" step="0.01" style="flex: 1; background: #1a1a1a; border: 1px solid #333; color: var(--accent); padding: 12px; border-radius: 10px; font-size: 14px; text-align: center; outline: none; min-width: 0;">
    `;
    container.appendChild(row);
};

window.calculateGWA = function() {
    const grades = document.querySelectorAll('.grade-input');
    let total = 0;
    let count = 0;

    grades.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) {
            total += val;
            count++;
        }
    });

    const result = count > 0 ? (total / count).toFixed(2) : "0.00";
    const display = document.getElementById('gwa-result');
    if (display) {
        display.innerText = result;
        display.style.transform = "scale(1.1)";
        setTimeout(() => display.style.transform = "scale(1)", 100);
    }
    
    if (navigator.vibrate) navigator.vibrate(50);
};
window.clearGrades = function() {
    const overlay = document.createElement('div');
    overlay.className = 'toast-overlay';
    overlay.id = 'temp-overlay';

    const toast = document.createElement('div');
    toast.className = 'custom-toast';
    toast.innerHTML = `
        <p style="color:white; margin-bottom: 20px; font-size: 14px;">Clear all subjects and grades?</p>
        <div style="display:flex; gap:10px;">
            <button id="confirm-clear" style="flex:1; background:var(--accent); color:black; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">YES</button>
            <button id="cancel-clear" style="flex:1; background:#222; color:white; border:1px solid #444; padding:10px; border-radius:8px; cursor:pointer;">NO</button>
        </div>
    `;

    document.body.appendChild(overlay);
    document.body.appendChild(toast);
    document.getElementById('confirm-clear').onclick = function() {
        const container = document.getElementById('grade-inputs-container');
        container.innerHTML = "";
        document.getElementById('gwa-result').innerText = "0.00";
        
        for (let i = 0; i < 4; i++) addSubjectRow();
        overlay.remove();
        toast.remove();
        
        if (navigator.vibrate) navigator.vibrate(50);
    };

    document.getElementById('cancel-clear').onclick = function() {
        overlay.remove();
        toast.remove();
    };
};

function showEmergencyBanner(sender, text) {
    const banner = document.createElement('div');
    banner.style = `position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(15,15,10,0.98); border:1.5px solid gold; padding:12px 18px; border-radius:15px; width:85%; max-width:350px; z-index:10000; display:flex; align-items:center; gap:12px; box-shadow:0 10px 40px rgba(0,0,0,0.6); color:white; font-family:sans-serif;`;
    banner.innerHTML = `<div style="font-size:24px;">ü§ù</div><div style="flex:1; overflow:hidden;"><div style="font-size:10px; color:gold; font-weight:800; letter-spacing:1px;">PEER BOARD UPDATE</div><div style="font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><b>${sender}:</b> ${text}</div></div>`;
    document.body.appendChild(banner);
    setTimeout(() => {
        banner.style.opacity = "0"; banner.style.transition = "0.5s";
        setTimeout(() => banner.remove(), 500);
    }, 4000);
}

const qPeerBackground = query(collection(db, "peer_posts"), orderBy("createdAt", "desc"));
onSnapshot(qPeerBackground, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
            const data = change.doc.data();
            const postId = change.doc.id;
            const rawUserData = localStorage.getItem('user_data');
            const currentUser = rawUserData ? JSON.parse(rawUserData) : null;
            if (data.createdAt > lastPostTime && currentUser && String(data.senderId) !== String(currentUser.uid) && !notifiedPostIds.has(postId)) {
                notifiedPostIds.add(postId);
                const sound = document.getElementById('notif-sound');
                if (sound) { sound.currentTime = 0; sound.play().catch(e => {}); }
                showEmergencyBanner(data.senderName, data.text);
                unreadCount++;
                const badge = document.getElementById('peerBadge');
                if (badge) {
                    badge.innerText = "+" + unreadCount;
                    badge.style.display = "block";
                }
            }
        }
    });

    const container = document.getElementById('peer-posts-container');
    if (container && container.offsetParent !== null) {
    }
});

window.reactToPost = async function(postId) {
    const rawData = localStorage.getItem('user_data');
    const user = rawData ? JSON.parse(rawData) : null;
    const isActuallyAdmin = user && (user.username === "hypens" || user.username === "C");

    if (!isActuallyAdmin && isReacting) return; 
    
    if (!isActuallyAdmin) isReacting = true; 

    try {
        const { getDoc, setDoc, deleteDoc, updateDoc, increment, doc, collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const postRef = doc(db, "peer_posts", postId);
        const likeRef = doc(db, "peer_posts", postId, "user_likes", user.uid);

        if (isActuallyAdmin) {
            await updateDoc(postRef, { likes: increment(1) });
            
            const postSnap = await getDoc(postRef);
            const postData = postSnap.data();
            if (postData.senderId !== user.uid) {
                await addDoc(collection(db, "notifications"), {
                    targetUid: postData.senderId,
                    senderName: user.username,
                    message: `${user.username} is spamming love to your post! ‚ù§Ô∏èüî•`,
                    type: "react",
                    status: "unread",
                    timestamp: serverTimestamp()
                });
            }
        } else {
            const likeSnap = await getDoc(likeRef);
            if (likeSnap.exists()) {
                await deleteDoc(likeRef);
                await updateDoc(postRef, { likes: increment(-1) });
            } else {
                await setDoc(likeRef, { uid: user.uid });
                await updateDoc(postRef, { likes: increment(1) });
                
                const postSnap = await getDoc(postRef);
                const postData = postSnap.data();
                if (postData.senderId !== user.uid) {
                    await addDoc(collection(db, "notifications"), {
                        targetUid: postData.senderId,
                        senderName: user.username,
                        message: `${user.username} reacted to your post ‚ù§Ô∏è`,
                        type: "react",
                        status: "unread",
                        timestamp: serverTimestamp()
                    });
                }
            }
        }
    } catch (e) { 
        console.error("React Error:", e); 
    } finally {
        isReacting = false; 
    }
};

window.openCommentModal = function(postId) {
    window.currentPostId = postId;
    const modal = document.getElementById('commentModal');
    if (modal) {
        modal.style.display = 'block';
        window.loadComments(postId);
                if (window.isAdmin) {
            document.getElementById('sendCommentBtn').classList.add('dev-send-btn');
        }
    }
};

window.closeCommentModal = function() {
    document.getElementById('commentModal').style.display = 'none';
};

window.loadComments = function(postId) {
    const q = query(collection(db, "peer_posts", postId, "comments"), orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById('commentsList');
        if (!list) return;
        list.innerHTML = "";
        
        snapshot.forEach((docSnap) => {
            const c = docSnap.data(); 
            const cid = docSnap.id;   
            const currentUser = loggedInUserDoc || JSON.parse(localStorage.getItem('user_data')) || {};
            
            const isCommentAdmin = (c.senderName === "hypens" || c.senderName === "C");
            const canDelete = (currentUser.username === "hypens" || currentUser.username === "C") || (c.senderId === currentUser.uid);

            list.innerHTML += `
                <div style="
                    margin-bottom: 12px !important; 
                    padding: 12px !important; 
                    background: ${isCommentAdmin ? 'linear-gradient(145deg, rgba(184, 134, 11, 0.2), rgba(10, 10, 10, 0.95))' : 'rgba(255,255,255,0.03)'} !important;
                    border: 1px solid ${isCommentAdmin ? '#FFD700' : 'rgba(255,255,255,0.08)'} !important;
                    box-shadow: ${isCommentAdmin ? '0 0 15px rgba(184, 134, 11, 0.3)' : 'none'} !important;
                    display: block !important; 
                    text-align: left !important;
                ">
                    <div style="display: flex !important; justify-content: space-between !important; align-items: flex-start !important;">
                        <div style="display: flex !important; align-items: center !important; gap: 10px !important;">
                            
                            <img src="${c.senderImg !== 'null' && c.senderImg ? c.senderImg : 'https://ui-avatars.com/api/?name='+c.senderName}" 
                                 style="
                                    width: 28px !important; 
                                    height: 28px !important; 
                                    min-width: 28px !important; 
                                    min-height: 28px !important; 
                                    max-width: 28px !important; 
                                    max-height: 28px !important; 
                                    border-radius: 50% !important; 
                                    object-fit: cover !important; 
                                    border: 1.5px solid ${isCommentAdmin ? '#FFD700' : 'transparent'} !important;
                                    flex-shrink: 0 !important; /* Ito ang pumipigil sa pag-stretch */
                                 ">
                            
                            <div style="display: flex !important; flex-direction: column !important; align-items: flex-start !important;">
                                <div style="display: flex !important; align-items: center !important; gap: 4px !important;">
                                    <strong style="color: ${isCommentAdmin ? '#FFD700' : '#fff'} !important; font-size: 13px !important; font-weight: 800 !important;">
                                        ${c.senderName}
                                    </strong>
                                    ${isCommentAdmin ? `<span style="font-size: 11px !important; color: #FFD700 !important; animation: goldShine 1.5s infinite !important;">‚ú¶</span>` : ''}
                                </div>
                                ${isCommentAdmin ? `<span style="font-size: 8px !important; color: #B8860B !important; font-weight: 900 !important; letter-spacing: 1px !important; margin-top: -2px !important;">DEV</span>` : ''}
                            </div>
                        </div>

                        ${canDelete ? `
                            <button onclick="window.deleteComment('${postId}', '${cid}')" style="background:none !important; border:none !important; color:rgba(255,68,68,0.7) !important; font-size:22px !important; cursor:pointer !important;">&times;</button>
                        ` : ''}
                    </div>

                    <p style="
                        color: #ddd !important; 
                        margin: 6px 0 0 38px !important; 
                        font-size: 13.5px !important; 
                        line-height: 1.5 !important;
                        text-align: left !important;
                        display: block !important;
                        word-break: break-all !important;
                    ">
                        ${c.text}
                    </p>
                </div>
            `;
        });
        list.scrollTop = list.scrollHeight;
    });
};
window.deleteComment = async function(postId, commentId) {    
    try { 
        const commentRef = doc(db, "peer_posts", postId, "comments", commentId);
        await deleteDoc(commentRef); 
        if (navigator.vibrate) navigator.vibrate(50); 
        showToast("Comment deleted successfully! üóëÔ∏è"); 
    } catch (e) { 
        console.error("Delete Error:", e);
        showToast("Failed to delete comment. ‚ùå");
    }
};

document.getElementById('sendCommentBtn').onclick = async () => {
    const input = document.getElementById('commentInput');
    const text = input.value.trim();

    if (!text || !window.currentPostId) return;

    try {
        await addDoc(collection(db, "peer_posts", window.currentPostId, "comments"), {
            text: text,
            senderName: window.userName || "Student",
            senderImg: window.userImg || "", 
            isAdmin: window.isAdmin || false,
            timestamp: serverTimestamp()
        });
        input.value = ""; 
    } catch (e) { 
        console.error("Send Error:", e);
        alert("Error sending comment!");
    }
};

document.getElementById('sendCommentBtn').onclick = async () => {
    const input = document.getElementById('commentInput');
    const text = input.value.trim();
    if (!text || !window.currentPostId) return;

    const user = loggedInUserDoc || JSON.parse(localStorage.getItem('user_data'));

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const userSnap = await getDoc(doc(db, "users", user.uid));
        
        if (userSnap.exists() && userSnap.data().isMuted === true) {
            showToast("üîá You are muted and cannot comment.");
            input.value = ""; 
            return; 
        }
    } catch (e) { console.error("Mute check error:", e); }

    try {
        await addDoc(collection(db, "peer_posts", window.currentPostId, "comments"), {
            text: text,
            senderName: user.username,
            senderImg: user.profilePic || "null",
            senderId: user.uid,
            timestamp: serverTimestamp()
        });
        const { getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const postSnap = await getDoc(doc(db, "peer_posts", window.currentPostId));
        const postData = postSnap.data();
        if (postData.senderId !== user.uid) {
            await addDoc(collection(db, "notifications"), {
                targetUid: postData.senderId, 
                senderName: user.username,
                message: `${user.username} commented on your post: "${text.substring(0, 15)}..."`,
                type: "comment",
                status: "unread",
                timestamp: serverTimestamp()
            });
        }

        input.value = "";
    } catch (e) { console.error(e); }
};
function initNotificationSystem() {
    const user = loggedInUserDoc || JSON.parse(localStorage.getItem('user_data'));
    if (!user) return;

    const q = query(
        collection(db, "notifications"), 
        where("targetUid", "==", user.uid), 
        where("status", "==", "unread")
    );

    onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const notif = change.doc.data();
                                const isAdmin = (notif.senderName === "hypens" || notif.senderName === "C");
                const isSpamLove = notif.message.includes("spamming love");

                if (isAdmin && isSpamLove) {
                    if (typeof window.fireAdminCheer === "function") {
                        window.fireAdminCheer(); 
                    }
                }
                const sound = document.getElementById('notif-sound');
                if (sound) { 
                    sound.currentTime = 0; 
                    sound.play().catch(e => {}); 
                }

                showToast(`üîî ${notif.message}`);
                updateDoc(doc(db, "notifications", change.doc.id), { status: "read" });
            }
        });
    });
}
window.fireAdminCheer = () => {
    adminCheerSound.currentTime = 0;
    adminCheerSound.play().catch(e => {});
    const body = document.body;
    body.classList.add('shake-effect');
        setTimeout(() => {
        body.classList.remove('shake-effect');
    }, 400);
    const emojis = ['‚ù§Ô∏è', 'üî•', 'üëë', '‚ú®'];
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.className = 'admin-heart';
            heart.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            heart.style.left = Math.random() * 100 + "vw";
            heart.style.animationDuration = (Math.random() * 0.5 + 1) + "s";
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 2000);
        }, i * 40);
    }
};

window.viewPeerProfile = async (uid) => {
    window.currentTargetUid = uid; 
    if (!uid) return;
    const modal = document.getElementById('peerUserModal');
    const currentUser = JSON.parse(localStorage.getItem('user_data'));
    const imgContainer = document.getElementById('peerModalImgContainer'); 

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const userSnap = await getDoc(doc(db, "users", uid));
        
        if (userSnap.exists()) {
            const uData = userSnap.data();
            
            document.getElementById('peerModalImg').src = uData.profilePic || 'https://ui-avatars.com/api/?name=' + uData.username;
            document.getElementById('peerModalName').innerText = uData.username;
            
            const fullNm = document.getElementById('peerModalFullName');
            if(fullNm) fullNm.innerText = uData.fullName || "";
            const roleEl = document.getElementById('peerModalRole');
            const isTargetAdmin = uData.username === "hypens" || uData.username === "C" || uData.role === "admin";
            
            if (isTargetAdmin) {
                roleEl.innerHTML = `<span class="admin-glow-text">DEVELOPER</span> <span class="admin-sparkle">‚ú¶</span>`;
                roleEl.style.color = "#FFD700";
                roleEl.style.fontWeight = "900";
                
                if(imgContainer) {
                    imgContainer.classList.add('admin-border-active');
                    imgContainer.style.background = "none"; 
                }
            } else {
                roleEl.innerText = uData.level || "Student";
                roleEl.className = ""; 
                roleEl.style.color = "#aaa";
                roleEl.style.fontWeight = "bold";
                
                if(imgContainer) {
                    imgContainer.classList.remove('admin-border-active');
                    imgContainer.style.background = "linear-gradient(45deg, #FFD700, #FFA500)"; 
                }
            }

            document.getElementById('peerModalBio').innerText = uData.bio || "No bio set.";
            const isAdmin = currentUser && (currentUser.username === "hypens" || currentUser.username === "C");
            const adminArea = document.getElementById('peerAdminControls');
            
            if (isAdmin && currentUser.uid !== uid) {
                adminArea.style.display = 'block';
                const muteBtn = document.getElementById('peerMuteBtn');
                muteBtn.innerText = uData.isMuted ? "Unmute User" : "Mute User";
                muteBtn.style.background = uData.isMuted ? "#44bb44" : "#ff4444";
            } else {
                adminArea.style.display = 'none';
            }

            modal.style.display = 'flex';
        }
    } catch (e) { console.error(e); }
};

window.closePeerModal = () => {
    document.getElementById('peerUserModal').style.display = 'none';
};

window.toggleMute = async () => {
    if (!window.currentTargetUid) return;

    try {
        const { doc, updateDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const userRef = doc(db, "users", window.currentTargetUid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            const currentStatus = userSnap.data().isMuted || false;
            const newStatus = !currentStatus;
            await updateDoc(userRef, { isMuted: newStatus });
            const muteBtn = document.getElementById('peerMuteBtn');
            muteBtn.innerText = newStatus ? "UNMUTE USER" : "MUTE USER";
            muteBtn.style.background = newStatus ? "#44bb44" : "#ff4444";
            if (window.showToast) {
                showToast(newStatus ? "User has been muted üîá" : "User has been unmuted üîä");
            }
            if (navigator.vibrate) navigator.vibrate(50);
        }
    } catch (e) { 
        console.error("Mute Error:", e);
        if (window.showToast) showToast("Error updating mute status ‚ùå");
    }
};
window.initDevAssistive = () => {
    const user = JSON.parse(localStorage.getItem('user_data'));
    const btn = document.getElementById('devAssistiveBtn');
        const isAdmin = user && (user.username === "hypens" || user.username === "C");
    if (!isAdmin) {
        if(btn) btn.remove(); 
        return;
    }

    btn.style.display = 'flex'; 

    let isDragging = false;
    let startX, startY;

    btn.onpointerdown = (e) => {
        isDragging = false;
        startX = e.clientX - btn.offsetLeft;
        startY = e.clientY - btn.offsetTop;
        btn.style.cursor = 'grabbing';

        document.onpointermove = (e) => {
            isDragging = true;
            let newX = e.clientX - startX;
            let newY = e.clientY - startY;
            btn.style.left = newX + 'px';
            btn.style.top = newY + 'px';
            btn.style.right = 'auto'; 
        };

        document.onpointerup = () => {
            btn.style.cursor = 'grab';
            document.onpointermove = null;
            document.onpointerup = null;
        };
    };

    btn.onclick = () => {
        if (!isDragging) {
            document.getElementById('devPanelOverlay').style.display = 'flex';
            loadDevUsers(); 
        }
    };
};

window.loadDevUsers = async () => {
    const container = document.getElementById('devUserList');
    try {
        const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        const querySnapshot = await getDocs(collection(db, "users"));
        
        container.innerHTML = "";
        querySnapshot.forEach((docSnap) => {
            const u = docSnap.data();
            const isMuted = u.isMuted || false;
            
            const row = document.createElement('div');
            row.style = "display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:15px; cursor:pointer; border:1px solid rgba(255,255,255,0.05);";
            
            row.onclick = () => {
                document.getElementById('devPanelOverlay').style.display = 'none';
                viewPeerProfile(docSnap.id); 
            };
            
            row.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="${u.profilePic || 'https://ui-avatars.com/api/?name='+u.username}" style="width:32px; height:32px; border-radius:50%; border:1px solid #FFD700;">
                    <span style="color:#eee; font-size:13px; font-weight:bold;">${u.username}</span>
                </div>
                <span>${isMuted ? "üîá" : "‚úÖ"}</span>
            `;
            container.appendChild(row);
        });
    } catch (e) { console.error(e); }
};
setTimeout(initDevAssistive, 2000);

window.previewImg = (input) => {
    if (input.files && input.files[0]) {
        window.selectedImgFile = input.files[0]; 
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const preview = document.getElementById('imgPreview');
            const cont = document.getElementById('imgPreviewCont');
            
            if (preview && cont) {
                preview.src = e.target.result;
                cont.style.display = 'block'; 
                console.log("Preview loaded!"); 
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
};
window.removeImg = () => {
    window.selectedImgFile = null;
    const input = document.getElementById('imgUpload');
    const cont = document.getElementById('imgPreviewCont');
    
    if (input) input.value = ""; 
    if (cont) cont.style.display = 'none'; 
};
window.viewFullImage = (url) => {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    if (modal && modalImg) {
        modalImg.src = url;
        modal.style.display = 'flex';
    }
};

window.switchDevTab = (tab) => {
    const userTab = document.getElementById('tab-users');
    const broadcastTab = document.getElementById('tab-broadcast');
    
    if (tab === 'users') {
        userTab.style.display = 'flex';
        broadcastTab.style.display = 'none';
    } else {
        userTab.style.display = 'none';
        broadcastTab.style.display = 'flex';
    }
};
window.handleBroadcastPush = () => {
    const msg = document.getElementById('bc-input').value;
    const effect = document.getElementById('bc-effect').value;
    
    if(!msg.trim()) return alert("Maglagay ka muna ng message!");
    
    window.sendAdminAbuse(msg, effect);
};

window.sendAdminAbuse = async (msg, effectType) => {
    try {
        await setDoc(doc(db, "system", "broadcast"), {
            adminName: "HYPENS", 
            message: msg.toUpperCase(),
            effect: effectType, 
            active: true,
            timestamp: Date.now()
        });
        alert(`SYSTEM OVERRIDE: ${effectType.toUpperCase()} LIVE! üöÄ`);
    } catch (e) {
        alert("Error: " + e.message);
    }
};

window.stopBroadcast = async () => {
    try {
        await updateDoc(doc(db, "system", "broadcast"), { active: false });
    } catch (e) { console.error(e); }
};

onSnapshot(doc(db, "system", "broadcast"), (snap) => {
    const banner = document.getElementById('admin-broadcast-banner');
    const textEl = document.getElementById('broadcast-text');
    const mainBGM = document.getElementById('bg-music'); 
        const broadcastEffects = ['effect-nika', 'effect-glitch', 'effect-action', 'effect-normal'];

    if (snap.exists() && snap.data().active) {
        const data = snap.data();
        const mode = data.effect || 'normal'; 

        if (mainBGM) mainBGM.pause();
        if (abuseBGM) { abuseBGM.pause(); abuseBGM = null; }
        
        try {
            const sfx = new Audio(`sounds/${mode}_notif.mp3`);
            sfx.play().catch(() => {});
            setTimeout(() => {
                abuseBGM = new Audio(`sounds/${mode}_loop.mp3`);
                abuseBGM.loop = true;
                abuseBGM.play().catch(() => {});
            }, 600);
        } catch (e) {}

        if (banner) {
            banner.style.setProperty('display', 'flex', 'important');
            banner.style.zIndex = "2147483647";
            if (mode === 'nika') {
                banner.style.background = "linear-gradient(90deg, #fff, #ffd700, #fff)";
                textEl.style.color = "#ff4500"; 
                banner.style.borderColor = "#ffd700";
            } else if (mode === 'glitch') {
                banner.style.background = "black";
                textEl.style.color = "#0f0";
                banner.style.borderColor = "#0f0";
            } else if (mode === 'action') {
                banner.style.background = "#8b0000"; 
                textEl.style.color = "white";
                banner.style.borderColor = "white";
            } else {
                banner.style.background = "rgba(0,0,0,0.95)";
                textEl.style.color = "gold";
                banner.style.borderColor = "gold";
            }
        }

        if (textEl) {
            textEl.style.animation = "none"; 
            void textEl.offsetWidth;
            textEl.innerHTML = `&nbsp;&nbsp;&nbsp; ${data.adminName}: ${data.message} // `.repeat(10);
            textEl.style.animation = "marquee-infinite 30s linear infinite";
        }

        document.body.classList.remove(...broadcastEffects);
        document.body.classList.add(`effect-${mode}`);

    } else {
        if (banner) banner.style.setProperty('display', 'none', 'important');
        if (abuseBGM) { abuseBGM.pause(); abuseBGM = null; }
        if (mainBGM) mainBGM.play().catch(() => {});

        document.body.classList.remove(...broadcastEffects);
        document.documentElement.classList.remove(...broadcastEffects);
    }
});
const checkDevAccess = () => {
    const rawUserData = localStorage.getItem('user_data');
    if (rawUserData) {
        const user = JSON.parse(rawUserData);
        if (user.username && user.username.toLowerCase() === 'hypens') {
            document.getElementById('devAssistiveBtn').style.display = 'flex';
        }
    }
};

checkDevAccess();
const devBtn = document.getElementById('devAssistiveBtn');
let isDragging = false;
let startX, startY;

devBtn.addEventListener('mousedown', (e) => {
    isDragging = false;
    startX = e.clientX;
    startY = e.clientY;
});

devBtn.addEventListener('mousemove', () => { isDragging = true; });

devBtn.addEventListener('mouseup', (e) => {
    if (!isDragging) {
        document.getElementById('devPanelOverlay').style.display = 'flex';
    }
});

devBtn.addEventListener('touchstart', (e) => {
    isDragging = false;
    const touch = e.touches[0];
    const offset = devBtn.getBoundingClientRect();
    devBtn.style.transition = 'none';
}, {passive: true});

devBtn.addEventListener('touchmove', (e) => {
    isDragging = true;
    const touch = e.touches[0];
    devBtn.style.left = (touch.clientX - 25) + 'px';
    devBtn.style.top = (touch.clientY - 25) + 'px';
    devBtn.style.right = 'auto';
}, {passive: true});

devBtn.addEventListener('touchend', (e) => {
    if (!isDragging) {
        document.getElementById('devPanelOverlay').style.display = 'flex';
    }
});

window.startNavCounters = (uid) => {
    if (!uid) return;

    const qSubs = query(collection(db, "subjects"), where("studentId", "==", uid));
    onSnapshot(qSubs, (subSnap) => {
        const sBadge = document.getElementById('sched-badge');
        if (sBadge) {
            sBadge.innerText = subSnap.size;
            sBadge.style.display = subSnap.size > 0 ? "flex" : "none";
        }

        const mySubIds = [];
        subSnap.forEach(d => mySubIds.push(d.id));

        const tBadge = document.getElementById('task-badge');
        if (mySubIds.length > 0) {
            const qTasks = query(collection(db, "student_tasks"), where("subjectId", "in", mySubIds));
            onSnapshot(qTasks, (taskSnap) => {
                if (tBadge) {
                    const pending = taskSnap.docs.filter(d => d.data().status !== "completed").length;
                    tBadge.innerText = pending;
                    tBadge.style.display = pending > 0 ? "flex" : "none";
                }
            });
        } else {
            if (tBadge) tBadge.style.display = "none";
        }
    });
};
initNotificationSystem();
initSystem();
</script>
</body>
</html>
